<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Function - ê²Œì„ í†µê³„ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: #0f0f0f;
            min-height: 100vh;
            padding: 10px;
            color: #b4b4b4;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-container {
            max-width: 450px;
            margin: 100px auto;
            background: #1a1a1a;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
            border: 1px solid #2a2a2a;
        }
        .login-container h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #e0e0e0;
            font-size: 28px;
        }
        .login-container input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
            background: #141414;
            color: #b4b4b4;
            font-size: 16px;
        }
        .login-container label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            color: #808080;
            cursor: pointer;
        }
        .login-container input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        .login-container button {
            width: 100%;
            padding: 15px;
            margin: 15px 0 5px 0;
            border-radius: 8px;
            border: none;
            background: #3a3a3a;
            color: #e0e0e0;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .login-container button:hover { background: #4a4a4a; transform: translateY(-2px); }
        
        /* ë©”ì¸ í™”ë©´ */
        .main-view { display: none; }
        .main-view.active { display: block; }
        
        /* í—¤ë” */
        .header {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 18px 25px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .header h1 { 
            color: #e0e0e0;
            font-size: 22px;
            font-weight: 700;
        }
        .header-right { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .username-badge {
            background: #3a3a3a;
            color: #e0e0e0;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        .admin-badge {
            background: #4a4a4a;
            color: #e0e0e0;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 5px;
        }
        .logout-btn {
            background: #f85149;
            color: white;
            padding: 6px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        .logout-btn:hover { background: #da3633; }
        
        /* ë¯¸ë‹ˆì°½ ìŠ¤íƒ€ì¼ ì‹¤ì‹œê°„ ì •ë³´ */
        .live-mini-window {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .live-mini-window h2 {
            color: #e0e0e0;
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }
        .mini-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        .mini-stat-box {
            background: #141414;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s;
        }
        .mini-stat-box:hover { 
            transform: translateY(-3px); 
            border-color: #3a3a3a;
            background: #1a1a1a;
        }
        .mini-stat-title {
            color: #808080;
            font-size: 12px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .mini-stat-value {
            color: #b4b4b4;
            font-size: 24px;
            font-weight: bold;
        }
        .mini-status-bar {
            background: #141414;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            text-align: center;
        }
        .mini-status-text {
            color: #808080;
            font-size: 14px;
        }
        .mini-status-text.in-game {
            color: #86efac;
            font-weight: bold;
        }
        .mini-tags {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .mini-tag {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #e0e0e0;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .mini-tag:hover {
            background: #3a3a3a;
            border-color: #4a4a4a;
            transform: translateY(-1px);
        }
        
        /* íƒ­ */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .tab-btn {
            padding: 12px 24px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            color: #808080;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 14px;
        }
        .tab-btn:hover { 
            background: #202020;
            color: #b4b4b4;
            border-color: #3a3a3a;
        }
        .tab-btn.active { 
            background: #2a2a2a;
            color: #e0e0e0;
            border-color: #4a4a4a;
        }
        
        /* ì¹´ë“œ */
        .card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        .card:hover {
            border-color: #3a3a3a;
        }
        .card h2 { 
            color: #e0e0e0; 
            margin-bottom: 20px; 
            font-size: 20px;
            font-weight: 600;
        }
        
        /* í†µê³„ ê·¸ë¦¬ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box {
            text-align: center;
            padding: 20px 15px;
            background: #202020;
            border: 1px solid #3a3a3a;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .stat-box:hover { 
            transform: translateY(-3px); 
            background: #2a2a2a;
            border-color: #4a4a4a;
        }
        .stat-value { 
            font-size: 36px; 
            font-weight: bold; 
            color: #e0e0e0;
        }
        .stat-label { 
            font-size: 13px; 
            margin-top: 8px; 
            color: #808080;
            font-weight: 500;
        }
        
        /* ìƒ‰ìƒ ë³€í˜• */
        .stat-box.green { 
            background: #1a2e26;
            border-color: #2d4a3e;
        }
        .stat-box.green:hover { 
            background: #1e3a2e;
            border-color: #3a5a4d;
        }
        .stat-box.green .stat-value { 
            color: #86efac;
        }
        
        .stat-box.red { 
            background: #2e1a1a;
            border-color: #4a2d2d;
        }
        .stat-box.red:hover { 
            background: #3a1e1e;
            border-color: #5a3a3a;
        }
        .stat-box.red .stat-value { 
            color: #fca5a5;
        }
        
        .stat-box.yellow { 
            background: #2e2a1a;
            border-color: #4a422d;
        }
        .stat-box.yellow:hover { 
            background: #3a341e;
            border-color: #5a523a;
        }
        .stat-box.yellow .stat-value { 
            color: #fcd34d;
        }
        
        .stat-box.purple { 
            background: #251a2e;
            border-color: #3d2d4a;
        }
        .stat-box.purple:hover { 
            background: #2e1e3a;
            border-color: #4d3a5a;
        }
        .stat-box.purple .stat-value { 
            color: #c4b5fd;
        }
        
        .stat-box.orange { 
            background: #2e221a;
            border-color: #4a382d;
        }
        .stat-box.orange:hover { 
            background: #3a2a1e;
            border-color: #5a483a;
        }
        .stat-box.orange .stat-value { 
            color: #fdba74;
        }
        
        /* í…Œì´ë¸” */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border-radius: 10px;
            background: #141414;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #2a2a2a;
        }
        th {
            background: #202020;
            color: #b4b4b4;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        tr:hover { 
            background: #1a1a1a;
            transition: all 0.2s ease;
        }
        
        /* ë­í‚¹ */
        .rank-1 { background: #ffd700 !important; color: #000 !important; font-weight: bold; }
        .rank-2 { background: #c0c0c0 !important; color: #000 !important; font-weight: bold; }
        .rank-3 { background: #cd7f32 !important; color: #000 !important; font-weight: bold; }
        .me-row { outline: 3px solid #1f6feb; }
        
        /* ìƒíƒœ ë°°ì§€ */
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending { background: #d29922; color: #000; }
        .status-approved { background: #238636; color: white; }
        .status-rejected { background: #f85149; color: white; }
        .status-suspended { background: #8b949e; color: white; }
        
        /* ì•¡ì…˜ ë²„íŠ¼ */
        .action-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        .action-buttons button {
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn-approve { background: #238636; color: white; }
        .btn-approve:hover { background: #2ea043; }
        .btn-reject { background: #f85149; color: white; }
        .btn-reject:hover { background: #da3633; }
        .btn-suspend { background: #d29922; color: white; }
        .btn-suspend:hover { background: #b58318; }
        .btn-delete { background: #8b949e; color: white; }
        .btn-delete:hover { background: #6e7681; }
        
        /* ì°¨íŠ¸ */
        #chartContainer { height: 250px; margin: 15px 0; }
        
        /* ë©”ì‹œì§€ */
        .message {
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 14px;
        }
        .error { background: #ff4444; color: white; }
        .success { background: #00C851; color: white; }
        .warning { background: #ffbb33; color: #000; }
        
        /* íƒ­ ì»¨í…ì¸  */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            body { padding: 5px; }
            .header { padding: 10px; }
            .header h1 { font-size: 16px; }
            .login-container { margin: 50px auto; padding: 25px; }
            .card { padding: 15px; }
            .stat-value { font-size: 28px; }
            .mini-stat-value { font-size: 20px; }
            table { font-size: 12px; }
            th, td { padding: 8px 5px; }
            .tabs { gap: 5px; }
            .tab-btn { padding: 8px 15px; font-size: 13px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="login-container" id="loginContainer">
            <h1>âš¡ Function</h1>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button id="showLoginBtn" onclick="showLoginForm()" style="flex: 1; background: #1f6feb;">ë¡œê·¸ì¸</button>
                <button id="showSignupBtn" onclick="showSignupForm()" style="flex: 1; background: #30363d;">íšŒì›ê°€ì…</button>
            </div>
            
            <div id="loginForm">
                <input type="text" id="loginUsername" placeholder="ì‚¬ìš©ìëª…">
                <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <label>
                    <input type="checkbox" id="autoLoginCheck" checked>
                    <span>ìë™ ë¡œê·¸ì¸</span>
                </label>
                <button onclick="login()">ë¡œê·¸ì¸</button>
            </div>
            
            <div id="signupForm" style="display: none;">
                <div style="color: #58a6ff; font-size: 13px; margin-bottom: 15px; padding: 10px; background: rgba(88, 166, 255, 0.1); border-radius: 6px; border: 1px solid #30363d;">
                    âš½ <strong>ì•„ì´ë””ëŠ” í”¼íŒŒ ë‹‰ë„¤ì„ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”</strong>
                </div>
                <input type="text" id="signupUsername" placeholder="í”¼íŒŒ ë‹‰ë„¤ì„ (2-20ì, í•œê¸€/ì˜ì–´/ìˆ«ì)">
                <input type="password" id="signupPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ (6-12ì)">
                <input type="password" id="signupPasswordConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
                <div style="color: #8b949e; font-size: 12px; margin: 10px 0; line-height: 1.5;">
                    âš ï¸ ë¹„ë°€ë²ˆí˜¸ ì¡°ê±´:<br>
                    â€¢ 6~12ì<br>
                    â€¢ ì˜ì–´, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¤‘ 2ê°€ì§€ ì´ìƒ í¬í•¨
                </div>
                <button onclick="signup()">íšŒì›ê°€ì…</button>
            </div>
            
            <div id="loginMessage"></div>
        </div>
        
        <div class="main-view" id="mainView">
            <div class="header">
                <h1>âš¡ Function</h1>
                <div class="header-right">
                    <span class="username-badge">
                        <span id="headerUsername"></span>
                        <span id="adminBadge" style="display:none;" class="admin-badge">ê´€ë¦¬ì</span>
                    </span>
                    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
            
            <div id="announcementBanner" style="display: none;"></div>
            
            <div id="announcementAdmin" style="display: none;">
                <div style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #58a6ff; margin-bottom: 15px;">ğŸ“¢ ê³µì§€ì‚¬í•­ ì‘ì„±</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="announcementInput" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                               style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #2a2a2a; background: #141414; color: #b4b4b4;">
                        <select id="announcementType" style="padding: 12px; border-radius: 8px; border: 1px solid #2a2a2a; background: #141414; color: #b4b4b4;">
                            <option value="info">â„¹ï¸ ì •ë³´</option>
                            <option value="success">âœ… ì„±ê³µ</option>
                            <option value="warning">âš ï¸ ê²½ê³ </option>
                            <option value="error">ğŸš¨ ì¤‘ìš”</option>
                        </select>
                        <button onclick="createAnnouncement()" 
                                style="padding: 12px 24px; background: #238636; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            ê²Œì‹œ
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="live-mini-window">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">ğŸ“¡ ì‹¤ì‹œê°„ ì •ë³´</h2>
                    <div style="text-align: right;">
                        <button id="manualRefreshBtn" onclick="manualRefresh()" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 13px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)';">
                            ğŸ”„ ê°±ì‹ 
                        </button>
                        <div id="lastUpdatedTime" style="font-size: 11px; color: #8b949e; margin-top: 5px;">
                            ë§ˆì§€ë§‰ ê°±ì‹ : ë°©ê¸ˆ ì „
                        </div>
                    </div>
                </div>
                <div class="mini-stats-grid">
                    <div class="mini-stat-box">
                        <div class="mini-stat-title">ì ìˆ˜</div>
                        <div class="mini-stat-value" id="liveScore">--</div>
                    </div>
                    <div class="mini-stat-box">
                        <div class="mini-stat-title">ë“±ìˆ˜</div>
                        <div class="mini-stat-value" id="liveRank">--</div>
                    </div>
                    <div class="mini-stat-box">
                        <div class="mini-stat-title">í‹°ì–´</div>
                        <div class="mini-stat-value" id="liveTier" style="font-size: 14px;">--</div>
                    </div>
                    <div class="mini-stat-box">
                        <div class="mini-stat-title">ìŠ¹-ë¬´-íŒ¨</div>
                        <div class="mini-stat-value" id="liveWLD" style="font-size: 16px;">0-0-0</div>
                    </div>
                    <div class="mini-stat-box">
                        <div class="mini-stat-title">ì±„êµ´FC</div>
                        <div class="mini-stat-value" id="liveFC">0</div>
                    </div>
                    <div class="mini-stat-box">
                        <div class="mini-stat-title">íŒìˆ˜</div>
                        <div class="mini-stat-value" id="liveMatches">0</div>
                    </div>
                </div>
                <div class="mini-status-bar">
                    <div class="mini-status-text" id="liveStatus" style="display: none;"></div>
                    <div class="mini-tags" id="liveTags"></div>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('today')">ì˜¤ëŠ˜</button>
                <button class="tab-btn" onclick="showTab('week')">7ì¼</button>
                <button class="tab-btn" onclick="showTab('history')">ì ìˆ˜ ê·¸ë˜í”„</button>
                <button class="tab-btn" onclick="showTab('updates')">ğŸ“¢ ì—…ë°ì´íŠ¸</button>
                <button class="tab-btn" id="adminTabBtn" style="display:none;" onclick="showTab('admin')">ğŸ‘‘ íšŒì›ê´€ë¦¬</button>
            </div>
            
            <div class="tab-content active" id="todayTab">
                <div class="card">
                    <h2>ğŸ“Š ì˜¤ëŠ˜ì˜ í†µê³„</h2>
                    <div class="stats-grid">
                        <div class="stat-box" style="background: #1a2e3a; border-color: #2a5a7a;">
                            <div class="stat-value" id="todayWins" style="color: #58a6ff;">0</div>
                            <div class="stat-label">ìŠ¹ë¦¬</div>
                        </div>
                        <div class="stat-box red">
                            <div class="stat-value" id="todayLosses">0</div>
                            <div class="stat-label">íŒ¨ë°°</div>
                        </div>
                        <div class="stat-box yellow">
                            <div class="stat-value" id="todayDraws">0</div>
                            <div class="stat-label">ë¬´ìŠ¹ë¶€</div>
                        </div>
                        <div class="stat-box green">
                            <div class="stat-value" id="todayFC">0</div>
                            <div class="stat-label">FC ì±„êµ´</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="todayMatches">0</div>
                            <div class="stat-label">íŒìˆ˜</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="todayWinrate">0%</div>
                            <div class="stat-label">ìŠ¹ë¥ </div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="todayStartScore">--</div>
                            <div class="stat-label">ì‹œì‘ ì ìˆ˜</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="todayHighScore">--</div>
                            <div class="stat-label">ìµœê³  ì ìˆ˜</div>
                        </div>
                    </div>
                </div>
                
                <div class="card" id="promotionCard" style="display: none;">
                    <h2>ğŸ† ìŠˆì±Œ â†’ ì±”ìŠ¤ ìŠ¹ê¸‰</h2>
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; color: #ffd700; margin-bottom: 10px;">ğŸ‰</div>
                        <div style="font-size: 24px; color: #58a6ff; font-weight: bold; margin-bottom: 10px;" id="promotionMatches">--íŒ</div>
                        <div style="color: #8b949e; font-size: 14px;" id="promotionDate">--</div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="weekTab">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;">ğŸ“… ìµœê·¼ 7ì¼ í†µê³„</h2>
                        <div style="text-align: right;">
                            <button id="refresh7DayBtn" onclick="refresh7DayStats()" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                border: none;
                                padding: 6px 14px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 12px;
                                font-weight: bold;
                                transition: all 0.3s ease;
                            ">
                                ğŸ“Š 7ì¼ ê°±ì‹ 
                            </button>
                            <div id="lastWeekUpdatedTime" style="font-size: 10px; color: #8b949e; margin-top: 3px;">
                                ë§ˆì§€ë§‰ ê°±ì‹ : ë°©ê¸ˆ ì „
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ë‚ ì§œ</th>
                                    <th>ìŠ¹</th>
                                    <th>ë¬´</th>
                                    <th>íŒ¨</th>
                                    <th>ìŠ¹ë¥ </th>
                                    <th>FC ì±„êµ´</th>
                                    <th>ìŠˆì±Œâ†’ì±”ìŠ¤</th>
                                </tr>
                            </thead>
                            <tbody id="weekTableBody">
                                <tr><td colspan="7" style="text-align:center;color:#8b949e;">ë¡œë”© ì¤‘...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="historyTab">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;">ğŸ“ˆ ì ìˆ˜ ê·¸ë˜í”„</h2>
                        <div style="text-align: right;">
                            <button id="refreshGraphBtn" onclick="refreshScoreGraph()" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                border: none;
                                padding: 6px 14px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 12px;
                                font-weight: bold;
                                transition: all 0.3s ease;
                            ">
                                ğŸ“ˆ ê·¸ë˜í”„ ê°±ì‹ 
                            </button>
                            <div id="lastGraphUpdatedTime" style="font-size: 10px; color: #8b949e; margin-top: 3px;">
                                ë§ˆì§€ë§‰ ê°±ì‹ : ë°©ê¸ˆ ì „
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-bottom: 15px;">
                        <button class="tab-btn active" style="margin: 5px;" onclick="this.classList.add('active'); document.querySelectorAll('#historyTab .tab-btn').forEach(b => { if (b !== this) b.classList.remove('active'); }); loadScoreGraph(100);">100ê²½ê¸°</button>
                        <button class="tab-btn" style="margin: 5px;" onclick="this.classList.add('active'); document.querySelectorAll('#historyTab .tab-btn').forEach(b => { if (b !== this) b.classList.remove('active'); }); loadScoreGraph(200);">200ê²½ê¸°</button>
                        <button class="tab-btn" style="margin: 5px;" onclick="this.classList.add('active'); document.querySelectorAll('#historyTab .tab-btn').forEach(b => { if (b !== this) b.classList.remove('active'); }); loadScoreGraph(300);">300ê²½ê¸°</button>
                    </div>
                    
                    <div style="height: 350px;">
                        <canvas id="scoreChart"></canvas>
                    </div>
                </div>
            </div>
            
            
            <div class="tab-content" id="updatesTab">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;">ğŸ“¢ ì—…ë°ì´íŠ¸ ê³µì§€</h2>
                        <button onclick="loadUpdates(true)" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 13px;
                            transition: all 0.2s;
                        ">
                            ğŸ“¢ ì—…ë°ì´íŠ¸ ê°±ì‹ 
                        </button>
                    </div>

                    <div id="updateWriteForm" style="display:none;">
                        <div style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                            <h3 style="color: #e0e0e0; margin-bottom: 15px; font-size: 16px;">âœï¸ ì—…ë°ì´íŠ¸ ì‘ì„±/ìˆ˜ì •</h3>
                            <input type="text" id="updateVersion" placeholder="ë²„ì „ (ì˜ˆ: v1.0.0)" 
                                style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #2a2a2a; background: #0a0a0a; color: #e0e0e0;">
                            <input type="text" id="updateTitle" placeholder="ì œëª©" 
                                style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #2a2a2a; background: #0a0a0a; color: #e0e0e0;">
                            <textarea id="updateContent" placeholder="ì—…ë°ì´íŠ¸ ë‚´ìš© (ì¤„ë°”ê¿ˆì€ Enterë¡œ)" rows="5"
                                style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #2a2a2a; background: #0a0a0a; color: #e0e0e0; resize: vertical; line-height: 1.5;"></textarea>
                            <input type="url" id="updateDownloadUrl" placeholder="ë‹¤ìš´ë¡œë“œ ë§í¬ (ì„ íƒì‚¬í•­ - êµ¬ê¸€ ë“œë¼ì´ë¸Œ, GitHub ë“±)" 
                                style="width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #2a2a2a; background: #0a0a0a; color: #e0e0e0;">
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button onclick="postUpdate()" id="postUpdateBtn"
                                    style="flex: 1; padding: 12px; background: #238636; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                    ğŸ“¤ ê²Œì‹œí•˜ê¸°
                                </button>
                                <button onclick="cancelEdit()" 
                                    style="padding: 12px 20px; background: #3a3a3a; color: #e0e0e0; border: 1px solid #4a4a4a; border-radius: 8px; cursor: pointer;">
                                    ì·¨ì†Œ
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="updatesList"></div>
                </div>
            </div>
            
            <div class="tab-content" id="adminTab">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;">ğŸ‘‘ íšŒì› ê´€ë¦¬</h2>
                        <div style="text-align: right;">
                            <button id="refreshAdminBtn" onclick="refreshAdminPanel()" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                border: none;
                                padding: 6px 14px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 12px;
                                font-weight: bold;
                                transition: all 0.3s ease;
                            ">
                                ğŸ‘¥ ì‚¬ìš©ì ëª©ë¡ ê°±ì‹ 
                            </button>
                            <div id="lastAdminUpdatedTime" style="font-size: 10px; color: #8b949e; margin-top: 3px;">
                                ë§ˆì§€ë§‰ ê°±ì‹ : ë°©ê¸ˆ ì „
                            </div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="totalUsers">0</div>
                            <div class="stat-label">ì „ì²´</div>
                        </div>
                        <div class="stat-box yellow">
                            <div class="stat-value" id="pendingUsers">0</div>
                            <div class="stat-label">ëŒ€ê¸°</div>
                        </div>
                        <div class="stat-box green">
                            <div class="stat-value" id="approvedUsers">0</div>
                            <div class="stat-label">ìŠ¹ì¸</div>
                        </div>
                        <div class="stat-box orange">
                            <div class="stat-value" id="activeToday">0</div>
                            <div class="stat-label">ì˜¤ëŠ˜</div>
                        </div>
                    </div>
                    
                    <h3 style="margin: 20px 0 10px 0; color: #d29922; font-size: 16px;">â³ ìŠ¹ì¸ ëŒ€ê¸°</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ì‚¬ìš©ìëª…</th>
                                    <th>ê°€ì…ì¼ì‹œ</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="pendingUsersBody"></tbody>
                        </table>
                    </div>
                    
                    <h3 style="margin: 20px 0 10px 0; color: #238636; font-size: 16px;">âœ… ìŠ¹ì¸ëœ íšŒì›</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ì‚¬ìš©ìëª…</th>
                                    <th>ë§ˆì§€ë§‰ ì ‘ì†</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="approvedUsersBody"></tbody>
                        </table>
                    </div>
                    
                    <h3 style="margin: 20px 0 10px 0; color: #f85149; font-size: 16px;">â¸ ì •ì§€ëœ íšŒì›</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ì‚¬ìš©ìëª…</th>
                                    <th>ì •ì§€ì¼ì‹œ</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="suspendedUsersBody"></tbody>
                        </table>
                    </div>
                    
                    <h3 style="margin: 20px 0 10px 0; color: #8b949e; font-size: 16px;">âœ— ê±°ë¶€ëœ íšŒì›</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ì‚¬ìš©ìëª…</th>
                                    <th>ê±°ë¶€ì¼ì‹œ</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="rejectedUsersBody"></tbody>
                        </table>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ë²„ì „ ì •ë³´ (ìºì‹œ í™•ì¸ìš©)
        const APP_VERSION = '2024-01-20-v2-fixed-406';
        console.log('ğŸš€ Function í†µê³„ ì‹œìŠ¤í…œ ë¡œë“œë¨ - ë²„ì „:', APP_VERSION);
        console.log('ğŸ“… ë¹Œë“œ ì‹œê°„:', new Date().toISOString());
        
        const SUPABASE_URL = 'https://tmbyzravuobepzicwpqe.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtYnl6cmF2dW9iZXB6aWN3cHFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1ODg2NTksImV4cCI6MjA3NzE2NDY1OX0.XIb1VE_r3_7PHwaFSppscpIgpaJ9cuvf5t0i67OeQCg';
        
        // [ìˆ˜ì •ë¨] ë³€ìˆ˜ëª… ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ supabase -> _supabaseë¡œ ë³€ê²½
        const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            realtime: {
                params: {
                    eventsPerSecond: 0  // Realtime ì´ë²¤íŠ¸ ì™„ì „ ë¹„í™œì„±í™”
                }
            }
        });
        
        let currentUser = null;
        let isAdmin = false;
        
        // í•œêµ­ ì‹œê°„(KST) ê¸°ì¤€ìœ¼ë¡œ ì˜¤ëŠ˜ ë‚ ì§œ ë°˜í™˜ (YYYY-MM-DD)
        function getTodayKST() {
            const now = new Date();
            // UTC ì‹œê°„ì— 9ì‹œê°„(í•œêµ­ ì‹œê°„ëŒ€)ì„ ë”í•¨
            const kstOffset = 9 * 60; // 9ì‹œê°„ì„ ë¶„ìœ¼ë¡œ ë³€í™˜
            const kstTime = new Date(now.getTime() + (kstOffset * 60 * 1000));
            
            // ISO ë¬¸ìì—´ë¡œ ë³€í™˜ í›„ ë‚ ì§œ ë¶€ë¶„ë§Œ ì¶”ì¶œ
            return kstTime.toISOString().split('T')[0];
        }
        
        // UTC ì‹œê°„ì„ í•œêµ­ ì‹œê°„(KST)ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ í¬ë§·íŒ…
        function formatDateKST(utcDateStr, format = 'date') {
            if (!utcDateStr) return 'ì—†ìŒ';
            const utcDate = new Date(utcDateStr);
            const kstDate = new Date(utcDate.getTime() + (9 * 60 * 60 * 1000));
            
            const year = kstDate.getUTCFullYear();
            const month = kstDate.getUTCMonth() + 1;
            const day = kstDate.getUTCDate();
            
            if (format === 'full') {
                return `${year}.${month}.${day}`;
            } else if (format === 'short') {
                return `${month}/${day}`;
            } else {
                return `${year}. ${month}. ${day}.`;
            }
        }
        
        // Realtime ì±„ë„ ë³€ìˆ˜
        let realtimeChannel = null;
        
        // Realtime êµ¬ë… ì‹œì‘ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸, Egress 95% ì ˆê°)
        // [Egress ìµœì í™”] Realtime êµ¬ë… ë¹„í™œì„±í™” - ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì „í™˜
        // ì´ì „: ìë™ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (70 MB Realtime egress/day)
        // í˜„ì¬: ì‚¬ìš©ìê°€ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ë°ì´í„° ë¡œë“œ (~0 MB Realtime egress)
        function startRealtimeSubscription() {
            // Realtime êµ¬ë… ë¹„í™œì„±í™”ë¨ - ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì‚¬ìš©
            console.log('â„¹ï¸ Realtime ìë™ êµ¬ë… ë¹„í™œì„±í™” (Egress ìµœì í™”: ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ë°©ì‹)');
            return;

            /* [ë¹„í™œì„±í™”ëœ ì½”ë“œ - Egress ì ˆê°ì„ ìœ„í•´ ì£¼ì„ ì²˜ë¦¬]
            // ê¸°ì¡´ ì±„ë„ ì œê±°
            if (realtimeChannel) {
                _supabase.removeChannel(realtimeChannel);
            }

            // Realtime ì±„ë„ êµ¬ë… (game_stats + daily_sessions)
            realtimeChannel = _supabase
                .channel(`user_stats_${currentUser}`)
                // 1. ì „ì²´ í†µê³„ (ì‹¤ì‹œê°„ ì •ë³´)
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'game_stats',
                    filter: `username=eq.${currentUser}`
                }, (payload) => {
                    console.log('ğŸ”” ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ì „ì²´ í†µê³„):', payload.new);
                    updateStatsDisplay(payload.new);
                })
                // 2. ì˜¤ëŠ˜ì˜ í†µê³„ (ì¼ì¼ ì„¸ì…˜)
                .on('postgres_changes', {
                    event: '*',  // INSERT, UPDATE ëª¨ë‘
                    schema: 'public',
                    table: 'daily_sessions',
                    filter: `username=eq.${currentUser}`
                }, (payload) => {
                    console.log('ğŸ”” ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ì˜¤ëŠ˜ì˜ í†µê³„):', payload.new);
                    updateDailySessionDisplay(payload.new);
                })
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('âœ… Realtime ì—°ê²° ì„±ê³µ! (ì „ì²´ í†µê³„ + ì˜¤ëŠ˜ì˜ í†µê³„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)');
                    } else if (status === 'CLOSED') {
                        console.log('âŒ Realtime ì—°ê²° ëŠê¹€. 5ì´ˆ í›„ ì¬ì—°ê²°...');
                        setTimeout(() => startRealtimeSubscription(), 5000);
                    } else if (status === 'CHANNEL_ERROR') {
                        console.log('âš ï¸ Realtime ì—°ê²° ì˜¤ë¥˜. 10ì´ˆ í›„ ì¬ì—°ê²°...');
                        setTimeout(() => startRealtimeSubscription(), 10000);
                    }
                });

            console.log('ğŸ”” Realtime êµ¬ë… ì‹œì‘ (ì „ì²´ í†µê³„ + ì˜¤ëŠ˜ì˜ í†µê³„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸, Egress 95% ì ˆê°)');
            */
        }
        
        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í™”ë©´ ë°˜ì˜ (ì „ì²´ í†µê³„)
        function updateStatsDisplay(data) {
            // ì‹¤ì‹œê°„ ì •ë³´ ì—…ë°ì´íŠ¸
            if (data.wins !== undefined) {
                document.getElementById('sessionWins').textContent = data.wins + 'ìŠ¹';
            }
            if (data.losses !== undefined) {
                document.getElementById('sessionLosses').textContent = data.losses + 'íŒ¨';
            }
            if (data.draws !== undefined) {
                document.getElementById('sessionDraws').textContent = data.draws + 'ë¬´';
            }
            if (data.matches !== undefined) {
                document.getElementById('sessionMatches').textContent = data.matches + 'íŒ';
            }
            if (data.fc_mined !== undefined) {
                document.getElementById('sessionFC').textContent = data.fc_mined + ' FC';
            }
            if (data.current_score !== undefined) {
                document.getElementById('currentScore').textContent = data.current_score;
            }
            if (data.current_rank !== undefined) {
                document.getElementById('currentRank').textContent = data.current_rank + 'ìœ„';
            }
            if (data.current_tier !== undefined) {
                document.getElementById('currentTier').textContent = data.current_tier;
            }
            if (data.game_status !== undefined) {
                document.getElementById('gameStatus').textContent = data.game_status;
            }
            
            // ìºì‹œ ì—…ë°ì´íŠ¸ (F5 ìƒˆë¡œê³ ì¹¨ ì‹œ ì‚¬ìš©)
            cachedStats = data;
            lastStatsLoad = Date.now();
            
            console.log('âœ¨ ì „ì²´ í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ (Realtime)');
        }
        
        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í™”ë©´ ë°˜ì˜ (ì˜¤ëŠ˜ì˜ í†µê³„)
        function updateDailySessionDisplay(data) {
            const today = getTodayKST();
            
            // ì˜¤ëŠ˜ ë‚ ì§œ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸
            if (data.session_date === today) {
                if (data.start_score !== undefined) {
                    document.getElementById('todayStartScore').textContent = data.start_score;
                }
                if (data.highest_score !== undefined) {
                    document.getElementById('todayHighestScore').textContent = data.highest_score;
                }
                if (data.wins !== undefined) {
                    document.getElementById('todayWins').textContent = data.wins + 'ìŠ¹';
                }
                if (data.losses !== undefined) {
                    document.getElementById('todayLosses').textContent = data.losses + 'íŒ¨';
                }
                if (data.draws !== undefined) {
                    document.getElementById('todayDraws').textContent = data.draws + 'ë¬´';
                }
                if (data.matches !== undefined) {
                    document.getElementById('todayMatches').textContent = data.matches + 'íŒ';
                }
                if (data.fc_mined !== undefined) {
                    document.getElementById('todayFC').textContent = data.fc_mined + ' FC';
                }
                
                // ìºì‹œ ì—…ë°ì´íŠ¸
                cachedDailySession = data;
                lastDailySessionLoad = Date.now();
                
                console.log('âœ¨ ì˜¤ëŠ˜ì˜ í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ (Realtime)');
            }
        }
        
        // ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ (F5 ëˆ„ë¥´ë©´ ê°•ì œë¡œ Supabaseì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F5' && currentUser) {
                e.preventDefault();
                loadMyStats(true); // forceRefresh = true
                
                // í˜„ì¬ í™œì„± íƒ­ë„ ê°•ì œ ìƒˆë¡œê³ ì¹¨ (forceRefresh = true)
                if (document.getElementById('weekTab').classList.contains('active')) {
                    loadWeekStats(true);
                } else if (document.getElementById('historyTab').classList.contains('active')) {
                    // íˆìŠ¤í† ë¦¬ íƒ­: í˜„ì¬ limit ì°¾ê¸°
                    const activeBtn = document.querySelector('#historyTab .tab-btn.active');
                    const limit = activeBtn ? parseInt(activeBtn.textContent.replace('ê²½ê¸°', '')) : 200;
                    loadScoreGraph(limit, true);
                } else if (document.getElementById('updatesTab').classList.contains('active')) {
                    loadUpdates(true);
                } else if (document.getElementById('adminTab').classList.contains('active')) {
                    loadAdminPanel(true);
                }
                console.log('ğŸ”„ ê°•ì œ ìƒˆë¡œê³ ì¹¨ (F5) - ëª¨ë“  ìºì‹œ ë¬´ì‹œ');
            }
        });
        
        // Realtime êµ¬ë… ì¤‘ì§€
        function stopRealtimeSubscription() {
            if (realtimeChannel) {
                _supabase.removeChannel(realtimeChannel);
                realtimeChannel = null;
                console.log('ğŸ”• Realtime êµ¬ë… ì¤‘ì§€');
            }
        }
        
        // ìë™ ë¡œê·¸ì¸ ì²´í¬
        window.onload = function() {
            const savedUsername = localStorage.getItem('function_username');
            const savedPassword = localStorage.getItem('function_password');
            
            if (savedUsername && savedPassword) {
                document.getElementById('loginUsername').value = savedUsername;
                document.getElementById('loginPassword').value = savedPassword;
                document.getElementById('autoLoginCheck').checked = true;
                login(true); // ìë™ ë¡œê·¸ì¸
            }
        };
        
        // ë¡œê·¸ì¸/íšŒì›ê°€ì… í¼ ì „í™˜
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('showLoginBtn').style.background = '#1f6feb';
            document.getElementById('showSignupBtn').style.background = '#30363d';
            document.getElementById('loginMessage').innerHTML = '';
        }
        
        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('showLoginBtn').style.background = '#30363d';
            document.getElementById('showSignupBtn').style.background = '#1f6feb';
            document.getElementById('loginMessage').innerHTML = '';
        }
        
        // íšŒì›ê°€ì…
        async function signup() {
            const username = document.getElementById('signupUsername').value.trim();
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
            
            if (!username || !password || !passwordConfirm) {
                showLoginMessage('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                showLoginMessage('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            // ì‚¬ìš©ìëª… ê²€ì¦ (2-20ì, í•œê¸€/ì˜ì–´/ìˆ«ìë§Œ)
            if (username.length < 2 || username.length > 20) {
                showLoginMessage('ì‚¬ìš©ìëª…ì€ 2~20ìì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            const usernameRegex = /^[ê°€-í£a-zA-Z0-9]+$/;
            if (!usernameRegex.test(username)) {
                showLoginMessage('ì‚¬ìš©ìëª…ì€ í•œê¸€, ì˜ì–´, ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ (6-12ì, ì˜ì–´/ìˆ«ì/íŠ¹ìˆ˜ë¬¸ì ì¤‘ 2ê°€ì§€ ì´ìƒ)
            if (password.length < 6 || password.length > 12) {
                showLoginMessage('ë¹„ë°€ë²ˆí˜¸ëŠ” 6~12ìì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            const complexityCount = [hasLetter, hasNumber, hasSpecial].filter(Boolean).length;
            
            if (complexityCount < 2) {
                showLoginMessage('ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ì–´, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¤‘ 2ê°€ì§€ ì´ìƒ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            try {
                // Supabase RPCë¥¼ í†µí•œ íšŒì›ê°€ì…
                const { data, error } = await _supabase.rpc('signup_user', {
                    username_param: username,
                    pin_param: password
                });
                
                if (error) {
                    if (error.message.includes('ì´ë¯¸ ì¡´ì¬')) {
                        showLoginMessage('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìëª…ì…ë‹ˆë‹¤.', 'error');
                    } else {
                        showLoginMessage('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + error.message, 'error');
                    }
                    return;
                }
                
                showLoginMessage('âœ… íšŒì›ê°€ì… ì„±ê³µ! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
                
                // 3ì´ˆ í›„ ë¡œê·¸ì¸ í¼ìœ¼ë¡œ ì „í™˜
                setTimeout(() => {
                    showLoginForm();
                    document.getElementById('signupUsername').value = '';
                    document.getElementById('signupPassword').value = '';
                    document.getElementById('signupPasswordConfirm').value = '';
                }, 3000);
                
            } catch (error) {
                showLoginMessage('íšŒì›ê°€ì… ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }
        
        // ë¡œê·¸ì¸
        async function login(auto = false) {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const autoLogin = document.getElementById('autoLoginCheck').checked;
            
            if (!username || !password) {
                if (!auto) showLoginMessage('ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }
            
            try {
                // [Egress ìµœì í™”] í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ (select '*' ëŒ€ì‹ )
                const { data: userData, error: userError } = await _supabase
                    .from('user_accounts')
                    .select('username, status, is_admin')
                    .eq('username', username)
                    .single();
                
                if (userError || !userData) {
                    if (!auto) showLoginMessage('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    if (auto) clearAutoLogin();
                    return;
                }
                
                if (userData.status !== 'approved') {
                    if (!auto) showLoginMessage('ê³„ì •ì´ ìŠ¹ì¸ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                    if (auto) clearAutoLogin();
                    return;
                }
                
                const { data: pinValid, error: pinError } = await _supabase.rpc('verify_pin', {
                    username_param: username,
                    pin_param: password
                });
                
                if (pinError || !pinValid) {
                    if (!auto) showLoginMessage('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                    if (auto) clearAutoLogin();
                    return;
                }
                
                // ë¡œê·¸ì¸ ì„±ê³µ!
                currentUser = userData.username;
                isAdmin = userData.is_admin || false;
                
                // ìë™ ë¡œê·¸ì¸ ì €ì¥
                if (autoLogin) {
                    localStorage.setItem('function_username', username);
                    localStorage.setItem('function_password', password);
                } else {
                    clearAutoLogin();
                }
                
                // ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì—…ë°ì´íŠ¸
                await _supabase.from('user_accounts').update({
                    last_login: new Date().toISOString()
                }).eq('username', username);
                
                showMainView();
                
            } catch (error) {
                if (!auto) showLoginMessage('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        function clearAutoLogin() {
            localStorage.removeItem('function_username');
            localStorage.removeItem('function_password');
        }
        
        function showLoginMessage(msg, type) {
            const msgDiv = document.getElementById('loginMessage');
            msgDiv.className = `message ${type}`;
            msgDiv.textContent = msg;
        }
        
        function showMainView() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainView').classList.add('active');
            
            document.getElementById('headerUsername').textContent = currentUser;
            
            if (isAdmin) {
                document.getElementById('adminBadge').style.display = 'inline';
                document.getElementById('adminTabBtn').style.display = 'block';
                document.getElementById('updateWriteForm').style.display = 'block';
                document.getElementById('announcementAdmin').style.display = 'block';  // ê³µì§€ ì‘ì„± í‘œì‹œ
            }
            
            // [Egress ìµœì í™”] ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì œê±° - ì™„ì „ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ëª¨ë“œ
            loadAnnouncements();  // ê³µì§€ì‚¬í•­ë§Œ ë¡œë“œ (í•„ìˆ˜)
            // loadMyStats(true); â† ì œê±°: ì‚¬ìš©ìê°€ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ë°ì´í„° ë¡œë“œ

            // [Egress ìµœì í™”] Realtime êµ¬ë… ë¹„í™œì„±í™”, íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸ ì‹œì‘
            startRealtimeSubscription(); // ë¹ˆ í•¨ìˆ˜ (ë¹„í™œì„±í™”ë¨)
            startTimestampUpdates();     // íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸ ì‹œì‘ (í˜ì´ì§€ ì ‘ì† ì‹œê°„ ê¸°ì¤€)
            console.log('â„¹ï¸ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ëª¨ë“œ: ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìµœì‹  ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš” (Egress 97% ì ˆê°)');
        }
        
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // Realtime êµ¬ë… ì¤‘ì§€
                stopRealtimeSubscription();

                // [Egress ìµœì í™”] íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸ ì¤‘ì§€ ë° ì´ˆê¸°í™”
                if (timestampUpdateInterval) {
                    clearInterval(timestampUpdateInterval);
                    timestampUpdateInterval = null;
                }
                lastManualRefreshTime = null;
                // localStorageëŠ” ìœ ì§€ (ë‹¤ìŒ ë¡œê·¸ì¸ ì‹œ ë³µì›ë¨)

                // ëª¨ë“  ìºì‹œ ì´ˆê¸°í™” (Egress ìµœì í™”)
                cachedStats = null;
                cachedDailySession = null;
                cachedWeekStats = null;
                cachedScoreGraph = null;
                cachedScoreGraphLimit = null;
                cachedPromotionInfo = null;
                cachedUpdates = null;
                cachedAdminPanel = null;
                lastStatsLoad = 0;
                lastDailySessionLoad = 0;
                lastWeekStatsLoad = 0;
                lastScoreGraphLoad = 0;
                lastPromotionInfoLoad = 0;
                lastUpdatesLoad = 0;
                lastAdminPanelLoad = 0;
                loadedComments.clear();
                
                clearAutoLogin();
                currentUser = null;
                isAdmin = false;
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainView').classList.remove('active');
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginMessage').innerHTML = '';
            }
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // [Egress ìµœì í™”] íƒ­ ì „í™˜ ì‹œ ìë™ ë¡œë“œ ì œê±° - ì‚¬ìš©ìê°€ ê°±ì‹  ë²„íŠ¼ í´ë¦­í•´ì•¼ë§Œ ë°ì´í„° ë¡œë“œ
            if (tabName === 'today') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('todayTab').classList.add('active');
                // loadMyStats(false); // ë¹„í™œì„±í™”: ìˆ˜ë™ ê°±ì‹  ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´
            } else if (tabName === 'week') {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('weekTab').classList.add('active');
                // loadWeekStats(false); // ë¹„í™œì„±í™”: ìˆ˜ë™ ê°±ì‹  ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´
            } else if (tabName === 'history') {
                document.querySelectorAll('.tab-btn')[2].classList.add('active');
                document.getElementById('historyTab').classList.add('active');
                // loadScoreGraph(200); // ë¹„í™œì„±í™”: ìˆ˜ë™ ê°±ì‹  ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´
            } else if (tabName === 'updates') {
                document.querySelectorAll('.tab-btn')[3].classList.add('active');
                document.getElementById('updatesTab').classList.add('active');
                // [Egress ìµœì í™”] ìë™ ë¡œë“œ ì œê±° - ìˆ˜ë™ ê°±ì‹  ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´
                // loadUpdates(); // ë¹„í™œì„±í™”: ìˆ˜ë™ ê°±ì‹  ë²„íŠ¼ ì‚¬ìš©
            } else if (tabName === 'admin' && isAdmin) {
                document.getElementById('adminTabBtn').classList.add('active');
                document.getElementById('adminTab').classList.add('active');
                // [Egress ìµœì í™”] ìë™ ë¡œë“œ ì œê±° - ì‚¬ìš©ìê°€ "ì‚¬ìš©ì ëª©ë¡ ê°±ì‹ " ë²„íŠ¼ í´ë¦­í•´ì•¼ ë¡œë“œ
                // loadAdminPanel(); // ë¹„í™œì„±í™”: ìˆ˜ë™ ê°±ì‹  ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´
            }
        }
        
        // ìºì‹± ë³€ìˆ˜ (Egress ì ˆê°)
        let cachedStats = null;
        let cachedDailySession = null;
        let cachedWeekStats = null;
        let cachedScoreGraph = null;
        let cachedScoreGraphLimit = null;
        let cachedPromotionInfo = null;
        let cachedUpdates = null;
        let cachedAdminPanel = null;
        let lastStatsLoad = 0;
        let lastDailySessionLoad = 0;
        let lastWeekStatsLoad = 0;
        let lastScoreGraphLoad = 0;
        let lastPromotionInfoLoad = 0;
        let lastUpdatesLoad = 0;
        let lastAdminPanelLoad = 0;
        // [Egress ìµœì í™”] ìºì‹œ ì‹œê°„ ëŒ€í­ ì¦ê°€ - ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ë°©ì‹ìœ¼ë¡œ ì „í™˜
        // ìë™ ì‹œê°„ ê¸°ë°˜ ìºì‹œ ê°±ì‹  ë¹„í™œì„±í™”, ì‚¬ìš©ìê°€ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ë°ì´í„° ë¡œë“œ
        const CACHE_TIME = 86400000; // 24ì‹œê°„ ìºì‹œ (ì‹¤ì§ˆì ìœ¼ë¡œ ë¹„í™œì„±í™”, ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ë§Œ ì‚¬ìš©)
        const RANKING_CACHE_TIME = 86400000; // 24ì‹œê°„ ìºì‹œ (ì‚¬ìš© ì•ˆ í•¨)
        const SCORE_GRAPH_CACHE_TIME = 86400000; // 24ì‹œê°„ ìºì‹œ (ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ë§Œ)
        const PROMOTION_CACHE_TIME = 86400000; // 24ì‹œê°„ ìºì‹œ (ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ë§Œ)
        const UPDATES_CACHE_TIME = 86400000; // 24ì‹œê°„ ìºì‹œ (ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ë§Œ)
        const ADMIN_CACHE_TIME = 86400000; // 24ì‹œê°„ ìºì‹œ (ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ë§Œ)
        let isAutoRefreshStarted = false; // ìë™ ê°±ì‹  ì‹œì‘ ì—¬ë¶€

        // [Egress ìµœì í™”] ìˆ˜ë™ ê°±ì‹  ì¶”ì  ë³€ìˆ˜ (ì„¹ì…˜ë³„ ë¶„ë¦¬)
        let lastManualRefreshTime = null; // ì‹¤ì‹œê°„ ì •ë³´ ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê°„
        let lastWeekRefreshTime = null;   // 7ì¼ í†µê³„ ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê°„
        let lastGraphRefreshTime = null;  // ê·¸ë˜í”„ ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê°„
        let lastAdminRefreshTime = null;  // ê´€ë¦¬ì íŒ¨ë„ ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê°„
        let timestampUpdateInterval = null; // íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸ ì¸í„°ë²Œ

        // [Egress ìµœì í™”] ì‹¤ì‹œê°„ ì •ë³´ ê°±ì‹  (ì‹¤ì‹œê°„ ì •ë³´ + ì˜¤ëŠ˜ì˜ í†µê³„ë§Œ)
        async function manualRefresh() {
            const btn = document.getElementById('manualRefreshBtn');

            // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© ìƒíƒœ í‘œì‹œ
            btn.disabled = true;
            btn.innerHTML = 'â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';

            try {
                // ì‹¤ì‹œê°„ ì •ë³´ + ì˜¤ëŠ˜ì˜ í†µê³„ë§Œ ë¡œë“œ (7ì¼/ê·¸ë˜í”„ëŠ” ë³„ë„ ë²„íŠ¼)
                await loadMyStats(true);

                // ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê°„ ì—…ë°ì´íŠ¸ ë° localStorageì— ì €ì¥
                lastManualRefreshTime = Date.now();
                localStorage.setItem('lastRefreshTime', lastManualRefreshTime.toString());
                updateTimestampDisplay();

                console.log('âœ… ì‹¤ì‹œê°„ ì •ë³´ ê°±ì‹  ì™„ë£Œ (Egress ìµœì í™”)');
            } catch (error) {
                console.error('âŒ ê°±ì‹  ì˜¤ë¥˜:', error);
            } finally {
                // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                btn.disabled = false;
                btn.innerHTML = 'ğŸ”„ ê°±ì‹ ';
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        }

        // [Egress ìµœì í™”] 7ì¼ í†µê³„ ê°±ì‹ 
        async function refresh7DayStats() {
            const btn = document.getElementById('refresh7DayBtn');
            if (!btn) return;

            btn.disabled = true;
            btn.innerHTML = 'â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            btn.style.opacity = '0.6';

            try {
                await loadWeekStats(true);

                lastWeekRefreshTime = Date.now();
                localStorage.setItem('lastWeekRefreshTime', lastWeekRefreshTime.toString());
                updateWeekTimestamp();

                console.log('âœ… 7ì¼ í†µê³„ ê°±ì‹  ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ 7ì¼ í†µê³„ ê°±ì‹  ì˜¤ë¥˜:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“Š 7ì¼ ê°±ì‹ ';
                btn.style.opacity = '1';
            }
        }

        // [Egress ìµœì í™”] ì ìˆ˜ ê·¸ë˜í”„ ê°±ì‹ 
        async function refreshScoreGraph() {
            const btn = document.getElementById('refreshGraphBtn');
            if (!btn) return;

            btn.disabled = true;
            btn.innerHTML = 'â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            btn.style.opacity = '0.6';

            try {
                // Find active graph limit button
                const activeBtn = document.querySelector('#historyTab .tab-btn.active');
                // [Egress ìµœì í™”] ê¸°ë³¸ê°’ 200â†’100 ê²½ê¸°ë¡œ ë³€ê²½
                const limit = parseInt(activeBtn?.textContent?.match(/\d+/)?.[0] || '100');
                await loadScoreGraph(limit, true);

                lastGraphRefreshTime = Date.now();
                localStorage.setItem('lastGraphRefreshTime', lastGraphRefreshTime.toString());
                updateGraphTimestamp();

                console.log('âœ… ì ìˆ˜ ê·¸ë˜í”„ ê°±ì‹  ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ê·¸ë˜í”„ ê°±ì‹  ì˜¤ë¥˜:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“ˆ ê·¸ë˜í”„ ê°±ì‹ ';
                btn.style.opacity = '1';
            }
        }

        // [Egress ìµœì í™”] ê´€ë¦¬ì íŒ¨ë„ ê°±ì‹ 
        async function refreshAdminPanel() {
            const btn = document.getElementById('refreshAdminBtn');
            if (!btn) return;

            btn.disabled = true;
            btn.innerHTML = 'â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            btn.style.opacity = '0.6';

            try {
                await loadAdminPanel(true);

                lastAdminRefreshTime = Date.now();
                localStorage.setItem('lastAdminRefreshTime', lastAdminRefreshTime.toString());
                updateAdminTimestamp();

                console.log('âœ… ê´€ë¦¬ì íŒ¨ë„ ê°±ì‹  ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ê´€ë¦¬ì íŒ¨ë„ ê°±ì‹  ì˜¤ë¥˜:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ‘¥ ì‚¬ìš©ì ëª©ë¡ ê°±ì‹ ';
                btn.style.opacity = '1';
            }
        }

        // íƒ€ì„ìŠ¤íƒ¬í”„ í‘œì‹œ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ì •ë³´ìš©)
        function updateTimestampDisplay() {
            const timestampEl = document.getElementById('lastUpdatedTime');
            if (!timestampEl) return;

            // lastManualRefreshTimeì´ ì—†ìœ¼ë©´ í˜ì´ì§€ ë¡œë“œ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œ
            const referenceTime = lastManualRefreshTime || Date.now();

            // ê²½ê³¼ ì‹œê°„ ê³„ì‚° (ë°€ë¦¬ì´ˆ â†’ ë¶„)
            const elapsed = Math.floor((Date.now() - referenceTime) / 60000);

            // 24ì‹œê°„(1440ë¶„) ì´ìƒ ê²½ê³¼í•œ ê²½ìš° â†’ localStorage ì •ë¦¬í•˜ê³  í˜ì´ì§€ ë¡œë“œ ì‹œê°„ìœ¼ë¡œ ì¬ì„¤ì •
            if (lastManualRefreshTime !== null && elapsed >= 1440) {
                lastManualRefreshTime = null;
                localStorage.removeItem('lastRefreshTime');
                // ì¬ê·€ í˜¸ì¶œë¡œ í˜ì´ì§€ ë¡œë“œ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ì‹œ í‘œì‹œ
                updateTimestampDisplay();
                return;
            }

            // ê²½ê³¼ ì‹œê°„ í‘œì‹œ
            let text;

            if (elapsed === 0) {
                text = 'ë°©ê¸ˆ ì „';
            } else if (elapsed < 60) {
                text = `${elapsed}ë¶„ ì „`;
            } else {
                const hours = Math.floor(elapsed / 60);
                text = `${hours}ì‹œê°„ ì „`;
            }

            timestampEl.textContent = `ë§ˆì§€ë§‰ ê°±ì‹ : ${text}`;
            timestampEl.style.color = '#8b949e'; // íšŒìƒ‰
        }

        // 7ì¼ í†µê³„ íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
        function updateWeekTimestamp() {
            const timestampEl = document.getElementById('lastWeekUpdatedTime');
            if (!timestampEl) return;

            const referenceTime = lastWeekRefreshTime || Date.now();
            const elapsed = Math.floor((Date.now() - referenceTime) / 60000);

            if (lastWeekRefreshTime !== null && elapsed >= 1440) {
                lastWeekRefreshTime = null;
                localStorage.removeItem('lastWeekRefreshTime');
                updateWeekTimestamp();
                return;
            }

            let text = elapsed === 0 ? 'ë°©ê¸ˆ ì „' : elapsed < 60 ? `${elapsed}ë¶„ ì „` : `${Math.floor(elapsed / 60)}ì‹œê°„ ì „`;
            timestampEl.textContent = `ë§ˆì§€ë§‰ ê°±ì‹ : ${text}`;
            timestampEl.style.color = '#8b949e';
        }

        // ê·¸ë˜í”„ íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
        function updateGraphTimestamp() {
            const timestampEl = document.getElementById('lastGraphUpdatedTime');
            if (!timestampEl) return;

            const referenceTime = lastGraphRefreshTime || Date.now();
            const elapsed = Math.floor((Date.now() - referenceTime) / 60000);

            if (lastGraphRefreshTime !== null && elapsed >= 1440) {
                lastGraphRefreshTime = null;
                localStorage.removeItem('lastGraphRefreshTime');
                updateGraphTimestamp();
                return;
            }

            let text = elapsed === 0 ? 'ë°©ê¸ˆ ì „' : elapsed < 60 ? `${elapsed}ë¶„ ì „` : `${Math.floor(elapsed / 60)}ì‹œê°„ ì „`;
            timestampEl.textContent = `ë§ˆì§€ë§‰ ê°±ì‹ : ${text}`;
            timestampEl.style.color = '#8b949e';
        }

        // ê´€ë¦¬ì íŒ¨ë„ íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
        function updateAdminTimestamp() {
            const timestampEl = document.getElementById('lastAdminUpdatedTime');
            if (!timestampEl) return;

            const referenceTime = lastAdminRefreshTime || Date.now();
            const elapsed = Math.floor((Date.now() - referenceTime) / 60000);

            if (lastAdminRefreshTime !== null && elapsed >= 1440) {
                lastAdminRefreshTime = null;
                localStorage.removeItem('lastAdminRefreshTime');
                updateAdminTimestamp();
                return;
            }

            let text = elapsed === 0 ? 'ë°©ê¸ˆ ì „' : elapsed < 60 ? `${elapsed}ë¶„ ì „` : `${Math.floor(elapsed / 60)}ì‹œê°„ ì „`;
            timestampEl.textContent = `ë§ˆì§€ë§‰ ê°±ì‹ : ${text}`;
            timestampEl.style.color = '#8b949e';
        }

        // [Egress ìµœì í™”] localStorageì—ì„œ ìºì‹œëœ ë°ì´í„° ë³µì› ë° í‘œì‹œ (zero egress)
        function restoreCachedData() {
            try {
                // ì‹¤ì‹œê°„ ì •ë³´ + ì˜¤ëŠ˜ì˜ í†µê³„ ë³µì›
                const savedStats = localStorage.getItem('cachedStats');
                if (savedStats) {
                    const stats = JSON.parse(savedStats);
                    cachedStats = stats;

                    // ì‹¤ì‹œê°„ ì •ë³´ í‘œì‹œ
                    const score = Number(stats.current_score);
                    const displayScore = (score && score > 0 && score < 10000) ? score : '--';
                    document.getElementById('liveScore').textContent = displayScore;

                    const rankElement = document.getElementById('liveRank');
                    if (stats.current_rank && stats.current_rank < 99999) {
                        rankElement.textContent = stats.current_rank;
                        rankElement.style.fontSize = '20px';
                    } else if (stats.current_rank >= 99999) {
                        rankElement.textContent = 'ìˆœìœ„ê¶Œì´íƒˆ';
                        rankElement.style.fontSize = '12px';
                    } else {
                        rankElement.textContent = '--';
                        rankElement.style.fontSize = '20px';
                    }

                    document.getElementById('liveTier').textContent = stats.current_tier || '--';
                    document.getElementById('liveWLD').textContent = `${stats.wins || 0}-${stats.draws || 0}-${stats.losses || 0}`;
                    document.getElementById('liveFC').textContent = stats.fc_mined || 0;
                    document.getElementById('liveMatches').textContent = stats.matches || 0;

                    const tagsContainer = document.getElementById('liveTags');
                    const activeModes = stats.active_modes ? stats.active_modes.split(',').filter(m => m.trim()) : [];
                    if (activeModes.length > 0) {
                        tagsContainer.innerHTML = activeModes.map(mode => `<span class="mini-tag">${mode}</span>`).join('');
                    } else {
                        tagsContainer.innerHTML = '';
                    }

                    console.log('âœ… ì‹¤ì‹œê°„ ì •ë³´ ìºì‹œ ë³µì› ì™„ë£Œ (zero egress)');
                }

                // ì˜¤ëŠ˜ì˜ í†µê³„ ë³µì›
                const savedDailySession = localStorage.getItem('cachedDailySession');
                if (savedDailySession) {
                    const todaySession = JSON.parse(savedDailySession);
                    cachedDailySession = todaySession;

                    if (todaySession) {
                        document.getElementById('todayWins').textContent = todaySession.wins || 0;
                        document.getElementById('todayLosses').textContent = todaySession.losses || 0;
                        document.getElementById('todayDraws').textContent = todaySession.draws || 0;
                        document.getElementById('todayMatches').textContent = todaySession.matches || 0;
                        document.getElementById('todayFC').textContent = todaySession.fc_mined || 0;
                        document.getElementById('todayStartScore').textContent = todaySession.start_score || '--';
                        document.getElementById('todayHighScore').textContent = todaySession.highest_score || '--';
                        console.log('âœ… ì˜¤ëŠ˜ì˜ í†µê³„ ìºì‹œ ë³µì› ì™„ë£Œ (zero egress)');
                    }
                }

                // 7ì¼ í†µê³„ ë³µì›
                const savedWeekStats = localStorage.getItem('cachedWeekStats');
                if (savedWeekStats) {
                    const weekCache = JSON.parse(savedWeekStats);
                    cachedWeekStats = weekCache;

                    const weekData = weekCache.weekData;
                    const promotions = weekCache.promotions;

                    if (weekData && weekData.length > 0) {
                        const tbody = document.getElementById('weekTableBody');
                        const promotionMap = {};
                        if (promotions) {
                            promotions.forEach(p => {
                                const date = p.promoted_at.split('T')[0];
                                promotionMap[date] = p.matches_taken;
                            });
                        }

                        let html = '';
                        weekData.forEach(day => {
                            const dateStr = formatDateKST(day.session_date, 'short');
                            const wins = day.wins || 0;
                            const losses = day.losses || 0;
                            const draws = day.draws || 0;
                            const total = wins + losses + draws;
                            const winrate = total > 0 ? ((wins / total) * 100).toFixed(1) : '0.0';
                            const fc = day.fc_mined || 0;
                            const promotion = promotionMap[day.session_date];
                            const promotionText = promotion ? `${promotion}íŒ` : '--';

                            html += `
                                <tr>
                                    <td style="color: #b4b4b4;">${dateStr}</td>
                                    <td style="color: #86efac; font-weight: 600;">${wins}</td>
                                    <td style="color: #fcd34d; font-weight: 600;">${draws}</td>
                                    <td style="color: #fca5a5; font-weight: 600;">${losses}</td>
                                    <td style="color: #e0e0e0; font-weight: 600;">${winrate}%</td>
                                    <td style="color: #fdba74; font-weight: 600;">${fc}</td>
                                    <td style="color: #c4b5fd; font-weight: 600;">${promotionText}</td>
                                </tr>
                            `;
                        });
                        tbody.innerHTML = html;
                        console.log('âœ… 7ì¼ í†µê³„ ìºì‹œ ë³µì› ì™„ë£Œ (zero egress)');
                    }
                }

                // ì ìˆ˜ ê·¸ë˜í”„ ë³µì›
                const savedScoreGraph = localStorage.getItem('cachedScoreGraph');
                if (savedScoreGraph) {
                    const graphCache = JSON.parse(savedScoreGraph);
                    cachedScoreGraph = graphCache.history;
                    cachedScoreGraphLimit = graphCache.limit;

                    if (graphCache.history && graphCache.history.length > 0) {
                        renderScoreGraph(graphCache.history, graphCache.limit);
                        console.log('âœ… ì ìˆ˜ ê·¸ë˜í”„ ìºì‹œ ë³µì› ì™„ë£Œ (zero egress)');
                    }
                }

            } catch (error) {
                console.error('ìºì‹œ ë³µì› ì˜¤ë¥˜:', error);
            }
        }

        // íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸ ì‹œì‘
        function startTimestampUpdates() {
            // ê¸°ì¡´ ì¸í„°ë²Œ ì œê±°
            if (timestampUpdateInterval) {
                clearInterval(timestampUpdateInterval);
            }

            // [Egress ìµœì í™”] localStorageì—ì„œ ê° ì„¹ì…˜ì˜ ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê°„ ë³µì›
            // ì‹¤ì‹œê°„ ì •ë³´
            const savedTime = localStorage.getItem('lastRefreshTime');
            if (savedTime) {
                const savedTimestamp = parseInt(savedTime);
                const elapsed = Math.floor((Date.now() - savedTimestamp) / 60000);
                if (elapsed < 1440) {
                    lastManualRefreshTime = savedTimestamp;
                    console.log(`â„¹ï¸ ì‹¤ì‹œê°„ ì •ë³´ ê°±ì‹  ì‹œê°„ ë³µì›: ${elapsed}ë¶„ ì „`);
                } else {
                    localStorage.removeItem('lastRefreshTime');
                }
            }

            // 7ì¼ í†µê³„
            const savedWeekTime = localStorage.getItem('lastWeekRefreshTime');
            if (savedWeekTime) {
                const savedTimestamp = parseInt(savedWeekTime);
                const elapsed = Math.floor((Date.now() - savedTimestamp) / 60000);
                if (elapsed < 1440) {
                    lastWeekRefreshTime = savedTimestamp;
                    console.log(`â„¹ï¸ 7ì¼ í†µê³„ ê°±ì‹  ì‹œê°„ ë³µì›: ${elapsed}ë¶„ ì „`);
                } else {
                    localStorage.removeItem('lastWeekRefreshTime');
                }
            }

            // ì ìˆ˜ ê·¸ë˜í”„
            const savedGraphTime = localStorage.getItem('lastGraphRefreshTime');
            if (savedGraphTime) {
                const savedTimestamp = parseInt(savedGraphTime);
                const elapsed = Math.floor((Date.now() - savedTimestamp) / 60000);
                if (elapsed < 1440) {
                    lastGraphRefreshTime = savedTimestamp;
                    console.log(`â„¹ï¸ ê·¸ë˜í”„ ê°±ì‹  ì‹œê°„ ë³µì›: ${elapsed}ë¶„ ì „`);
                } else {
                    localStorage.removeItem('lastGraphRefreshTime');
                }
            }

            // ê´€ë¦¬ì íŒ¨ë„
            const savedAdminTime = localStorage.getItem('lastAdminRefreshTime');
            if (savedAdminTime) {
                const savedTimestamp = parseInt(savedAdminTime);
                const elapsed = Math.floor((Date.now() - savedTimestamp) / 60000);
                if (elapsed < 1440) {
                    lastAdminRefreshTime = savedTimestamp;
                    console.log(`â„¹ï¸ ê´€ë¦¬ì íŒ¨ë„ ê°±ì‹  ì‹œê°„ ë³µì›: ${elapsed}ë¶„ ì „`);
                } else {
                    localStorage.removeItem('lastAdminRefreshTime');
                }
            }

            // [Egress ìµœì í™”] localStorageì—ì„œ ìºì‹œëœ ë°ì´í„° ë³µì› ë° í‘œì‹œ (zero egress)
            restoreCachedData();

            // 1ë¶„ë§ˆë‹¤ ëª¨ë“  íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
            timestampUpdateInterval = setInterval(() => {
                updateTimestampDisplay();
                updateWeekTimestamp();
                updateGraphTimestamp();
                updateAdminTimestamp();
            }, 60000);

            // ì¦‰ì‹œ í•œ ë²ˆ ì—…ë°ì´íŠ¸
            updateTimestampDisplay();
            updateWeekTimestamp();
            updateGraphTimestamp();
            updateAdminTimestamp();
        }

        // ë‚´ í†µê³„ ë¡œë“œ (ì‹¤ì‹œê°„ ì •ë³´ í¬í•¨) - ìºì‹± ì ìš©
        async function loadMyStats(forceRefresh = false) {
            const now = Date.now();
            
            // Realtimeì€ ë¡œê·¸ì¸ ì‹œ ìë™ ì‹œì‘ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë¶ˆí•„ìš”
            
            // ì „ì²´ í†µê³„ ë¡œë“œ (ì‹¤ì‹œê°„ ì •ë³´ìš©) - 5ë¶„ ìºì‹± (Egress ìµœì í™”: í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ)
            let stats = cachedStats;
            if (forceRefresh || !cachedStats || now - lastStatsLoad > CACHE_TIME) {
                const { data: freshStats, error: statsError } = await _supabase
                    .from('game_stats')
                    .select('current_score, current_rank, current_tier, wins, draws, losses, fc_mined, matches, active_modes')
                    .eq('username', currentUser)
                    .maybeSingle(); // single() ëŒ€ì‹  maybeSingle() ì‚¬ìš© (ë°ì´í„° ì—†ì„ ë•Œ null ë°˜í™˜, 406 ì—ëŸ¬ ë°©ì§€)
                
                if (statsError) {
                    console.error('[loadMyStats] game_stats ì¿¼ë¦¬ ì˜¤ë¥˜:', statsError);
                    // ì—ëŸ¬ê°€ ìˆì–´ë„ ê³„ì† ì§„í–‰ (Realtimeì´ ìˆìœ¼ë¯€ë¡œ)
                    stats = null;
                } else {
                    stats = freshStats;
                    cachedStats = freshStats;
                    lastStatsLoad = now;
                    // [Egress ìµœì í™”] localStorageì— ìºì‹œ ì €ì¥ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ í‘œì‹œ)
                    localStorage.setItem('cachedStats', JSON.stringify(freshStats));
                }
            }

            if (stats) {
                // ì‹¤ì‹œê°„ ë¯¸ë‹ˆì°½ ì •ë³´ (í˜„ì¬ ê°’ í‘œì‹œ) - 5ìë¦¬ ì´ìƒ í•„í„°ë§
                const score = Number(stats.current_score);
                const displayScore = (score && score > 0 && score < 10000) ? score : '--';
                document.getElementById('liveScore').textContent = displayScore;
                
                // ë“±ìˆ˜ í‘œì‹œ (ìˆœìœ„ê¶Œì´íƒˆ í¬í•¨)
                const rankElement = document.getElementById('liveRank');
                if (stats.current_rank && stats.current_rank < 99999) {
                    rankElement.textContent = stats.current_rank;
                    rankElement.style.fontSize = '20px';
                } else if (stats.current_rank >= 99999) {
                    rankElement.textContent = 'ìˆœìœ„ê¶Œì´íƒˆ';
                    rankElement.style.fontSize = '12px';
                } else {
                    rankElement.textContent = '--';
                    rankElement.style.fontSize = '20px';
                }
                
                document.getElementById('liveTier').textContent = stats.current_tier || '--';
                document.getElementById('liveWLD').textContent = `${stats.wins || 0}-${stats.draws || 0}-${stats.losses || 0}`;
                document.getElementById('liveFC').textContent = stats.fc_mined || 0;
                document.getElementById('liveMatches').textContent = stats.matches || 0;
                
                // ê²Œì„ ìƒíƒœ í‘œì‹œ ì œê±° (í™œì„± ëª¨ë“œë§Œ í‘œì‹œ)
                // const status = stats.game_status || 'ëŒ€ê¸° ì¤‘';
                // document.getElementById('liveStatus').textContent = status;
                
                // í™œì„± ëª¨ë“œ íƒœê·¸ í‘œì‹œ
                const tagsContainer = document.getElementById('liveTags');
                const activeModes = stats.active_modes ? stats.active_modes.split(',').filter(m => m.trim()) : [];
                
                if (activeModes.length > 0) {
                    tagsContainer.innerHTML = activeModes.map(mode => 
                        `<span class="mini-tag">${mode}</span>`
                    ).join('');
                } else {
                    tagsContainer.innerHTML = '';
                }
            }
            
            // ì˜¤ëŠ˜ì˜ í†µê³„ ë¡œë“œ (í•œêµ­ ì‹œê°„ ê¸°ì¤€) - 5ë¶„ ìºì‹± (Egress ìµœì í™”: í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ)
            const today = getTodayKST();
            let todaySession = cachedDailySession;
            if (forceRefresh || !cachedDailySession || now - lastDailySessionLoad > CACHE_TIME) {
                const { data: freshSession, error: sessionError } = await _supabase
                    .from('daily_sessions')
                    .select('wins, losses, draws, matches, fc_mined, start_score, highest_score')
                    .eq('username', currentUser)
                    .eq('session_date', today)
                    .maybeSingle(); // single() ëŒ€ì‹  maybeSingle() ì‚¬ìš© (ë°ì´í„° ì—†ì„ ë•Œ null ë°˜í™˜, 406 ì—ëŸ¬ ë°©ì§€)
                
                if (sessionError) {
                    console.error('[loadMyStats] daily_sessions ì¿¼ë¦¬ ì˜¤ë¥˜:', sessionError);
                    // ì—ëŸ¬ê°€ ìˆì–´ë„ ê³„ì† ì§„í–‰ (ì˜¤ëŠ˜ ì²« ê²Œì„ì´ë©´ ë°ì´í„°ê°€ ì—†ì„ ìˆ˜ ìˆìŒ)
                    todaySession = null;
                } else {
                    todaySession = freshSession;
                    cachedDailySession = freshSession;
                    lastDailySessionLoad = now;
                    // [Egress ìµœì í™”] localStorageì— ìºì‹œ ì €ì¥ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ í‘œì‹œ)
                    localStorage.setItem('cachedDailySession', JSON.stringify(freshSession));
                }
            }

            if (todaySession) {
                document.getElementById('todayWins').textContent = todaySession.wins || 0;
                document.getElementById('todayLosses').textContent = todaySession.losses || 0;
                document.getElementById('todayDraws').textContent = todaySession.draws || 0;
                document.getElementById('todayMatches').textContent = todaySession.matches || 0;
                document.getElementById('todayFC').textContent = todaySession.fc_mined || 0;
                document.getElementById('todayStartScore').textContent = todaySession.start_score || '--';
                document.getElementById('todayHighScore').textContent = todaySession.highest_score || '--';
                
                const total = (todaySession.wins || 0) + (todaySession.losses || 0) + (todaySession.draws || 0);
                const winrate = total > 0 ? ((todaySession.wins || 0) / total * 100).toFixed(1) : 0;
                document.getElementById('todayWinrate').textContent = winrate + '%';
            }
            
            // ìŠ¹ê¸‰ ì •ë³´ ë¡œë“œ (ìºì‹± ì ìš©)
            await loadPromotionInfo(false);
        }
        
        // ìµœê·¼ 7ì¼ í†µê³„ ë¡œë“œ (í•œêµ­ ì‹œê°„ ê¸°ì¤€) (Egress ìµœì í™”: ìºì‹± ì¶”ê°€)
        async function loadWeekStats(forceRefresh = false) {
            const now = Date.now();
            let weekData = cachedWeekStats?.weekData || cachedWeekStats;
            let promotions = cachedWeekStats?.promotions || null;

            if (forceRefresh || !cachedWeekStats || now - lastWeekStatsLoad > CACHE_TIME) {
                // í•œêµ­ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ 7ì¼ ì „ ë‚ ì§œ ê³„ì‚°
                const dateNow = new Date();
                const kstOffset = 9 * 60 * 60 * 1000; // 9ì‹œê°„ì„ ë°€ë¦¬ì´ˆë¡œ
                const kstNow = new Date(dateNow.getTime() + kstOffset);
                kstNow.setDate(kstNow.getDate() - 7);
                const sevenDaysAgo = kstNow.toISOString().split('T')[0];
                
                const { data: freshWeekData } = await _supabase
                    .from('daily_sessions')
                    .select('session_date, wins, losses, draws, fc_mined')
                    .eq('username', currentUser)
                    .gte('session_date', sevenDaysAgo)
                    .order('session_date', { ascending: false });
                weekData = freshWeekData;

                // ìŠˆì±Œâ†’ì±”ìŠ¤ ìŠ¹ê¸‰ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (í•œêµ­ ì‹œê°„ ê¸°ì¤€) (Egress ìµœì í™”)
                const { data: freshPromotions } = await _supabase
                .from('tier_promotions')
                    .select('promoted_at, matches_taken')
                    .eq('username', currentUser)
                    .eq('from_tier', 'ìŠˆì±Œ')
                    .eq('to_tier', 'ì±”ìŠ¤')
                    .gte('promoted_at', sevenDaysAgo)
                    .order('promoted_at', { ascending: false });
                promotions = freshPromotions;

                // [Egress ìµœì í™”] ìºì‹œ ë° localStorage ì €ì¥ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ í‘œì‹œ)
                cachedWeekStats = {weekData: freshWeekData, promotions: freshPromotions};
                lastWeekStatsLoad = now;
                localStorage.setItem('cachedWeekStats', JSON.stringify(cachedWeekStats));
            }
            
            const tbody = document.getElementById('weekTableBody');
            
            if (!weekData || weekData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#8b949e;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }
            
            // ë‚ ì§œë³„ ìŠ¹ê¸‰ ì •ë³´ ë§¤í•‘
            const promotionMap = {};
            if (promotions) {
                promotions.forEach(p => {
                    const date = p.promoted_at.split('T')[0];
                    promotionMap[date] = p.matches_taken;
                });
            }
            
            // í‘œ ì±„ìš°ê¸°
            let html = '';
            weekData.forEach(day => {
                // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë‚ ì§œ í‘œì‹œ
                const dateStr = formatDateKST(day.session_date, 'short');
                
                const wins = day.wins || 0;
                const losses = day.losses || 0;
                const draws = day.draws || 0;
                const total = wins + losses + draws;
                const winrate = total > 0 ? ((wins / total) * 100).toFixed(1) : '0.0';
                const fc = day.fc_mined || 0;
                
                const promotion = promotionMap[day.session_date];
                const promotionText = promotion ? `${promotion}íŒ` : '--';
                
                html += `
                    <tr>
                        <td style="color: #b4b4b4;">${dateStr}</td>
                        <td style="color: #86efac; font-weight: 600;">${wins}</td>
                        <td style="color: #fcd34d; font-weight: 600;">${draws}</td>
                        <td style="color: #fca5a5; font-weight: 600;">${losses}</td>
                        <td style="color: #e0e0e0; font-weight: 600;">${winrate}%</td>
                        <td style="color: #fdba74; font-weight: 600;">${fc}</td>
                        <td style="color: #c4b5fd; font-weight: 600;">${promotionText}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // ìŠˆì±Œâ†’ì±”ìŠ¤ ìŠ¹ê¸‰ ì •ë³´ ë¡œë“œ (Egress ìµœì í™”: í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ + ìºì‹±)
        async function loadPromotionInfo(forceRefresh = false) {
            const now = Date.now();
            
            // ìºì‹œ í™•ì¸
            if (!forceRefresh && cachedPromotionInfo && now - lastPromotionInfoLoad < PROMOTION_CACHE_TIME) {
                const promotion = cachedPromotionInfo;
                if (promotion) {
                    document.getElementById('promotionCard').style.display = 'block';
                    document.getElementById('promotionMatches').textContent = `${promotion.matches_taken || '--'}íŒ`;
                    const dateStr = formatDateKST(promotion.promoted_at, 'full');
                    document.getElementById('promotionDate').textContent = `${dateStr} ìŠ¹ê¸‰`;
                } else {
                    document.getElementById('promotionCard').style.display = 'none';
                }
                return;
            }
            
            const { data: promotion, error: promotionError } = await _supabase
                .from('tier_promotions')
                .select('promoted_at, matches_taken')
                .eq('username', currentUser)
                .eq('from_tier', 'ìŠˆì±Œ')
                .eq('to_tier', 'ì±”ìŠ¤')
                .order('promoted_at', { ascending: false })
                .limit(1)
                .maybeSingle(); // single() ëŒ€ì‹  maybeSingle() ì‚¬ìš© (ë°ì´í„° ì—†ì„ ë•Œ null ë°˜í™˜, 406 ì—ëŸ¬ ë°©ì§€)
            
            if (promotionError) {
                console.error('[loadPromotionInfo] ìŠ¹ê¸‰ ì •ë³´ ì¿¼ë¦¬ ì˜¤ë¥˜:', promotionError);
                cachedPromotionInfo = null;
            } else {
                // ìºì‹œ ì €ì¥
                cachedPromotionInfo = promotion;
            }
            lastPromotionInfoLoad = now;
            
            if (promotion) {
                document.getElementById('promotionCard').style.display = 'block';
                document.getElementById('promotionMatches').textContent = `${promotion.matches_taken || '--'}íŒ`;
                
                // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë‚ ì§œ í‘œì‹œ
                const dateStr = formatDateKST(promotion.promoted_at, 'full');
                document.getElementById('promotionDate').textContent = `${dateStr} ìŠ¹ê¸‰`;
            } else {
                document.getElementById('promotionCard').style.display = 'none';
            }
        }
        
        // ìµœê·¼ Nê²½ê¸° ì ìˆ˜ ê·¸ë˜í”„ (Egress ìµœì í™”: í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ + ìºì‹±)
        async function loadScoreGraph(limit, forceRefresh = false) {
            try {
                const now = Date.now();
                
                // ìºì‹œê°€ ìˆê³  ê°™ì€ limitì´ê³  ìœ íš¨í•˜ë©´ ìºì‹œ ì‚¬ìš©
                if (!forceRefresh && cachedScoreGraph && cachedScoreGraphLimit === limit && 
                    now - lastScoreGraphLoad < SCORE_GRAPH_CACHE_TIME) {
                    // ìºì‹œëœ ë°ì´í„°ë¡œ ê·¸ë˜í”„ ë Œë”ë§
                    const history = cachedScoreGraph;
                    renderScoreGraph(history, limit);
                    return;
                }
                
                // currentUserê°€ ì—†ìœ¼ë©´ ì—ëŸ¬
                if (!currentUser) {
                    console.error('âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    renderScoreGraph(null, limit);
                    return;
                }
                
                // [Egress ìµœì í™”] 'result' ì»¬ëŸ¼ ì œê±° (ê·¸ë˜í”„ì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
                const { data: history, error } = await _supabase
                    .from('game_history')
                    .select('created_at, score_after')
                    .eq('username', currentUser)
                    .order('created_at', { ascending: false })
                    .limit(limit);
                
                if (error) {
                    console.error('ì ìˆ˜ ê·¸ë˜í”„ ë¡œë“œ ì˜¤ë¥˜:', error);
                    renderScoreGraph(null, limit);
                    return;
                }
                
                // ìºì‹œ ì €ì¥
                cachedScoreGraph = history || [];
                cachedScoreGraphLimit = limit;
                lastScoreGraphLoad = now;

                // [Egress ìµœì í™”] localStorageì— ìºì‹œ ì €ì¥ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ í‘œì‹œ)
                localStorage.setItem('cachedScoreGraph', JSON.stringify({history: history || [], limit: limit}));

                renderScoreGraph(history || [], limit);
            } catch (error) {
                console.error('ì ìˆ˜ ê·¸ë˜í”„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                renderScoreGraph(null, limit);
            }
        }
        
        // ì ìˆ˜ ê·¸ë˜í”„ ë Œë”ë§ í•¨ìˆ˜ (ì¬ì‚¬ìš©)
        function renderScoreGraph(history, limit) {
            try {
                // ê¸°ì¡´ ì°¨íŠ¸ ì•ˆì „í•˜ê²Œ ì œê±°
                if (window.scoreChart && typeof window.scoreChart.destroy === 'function') {
                    try {
                        window.scoreChart.destroy();
                    } catch (e) {
                        console.warn('ê¸°ì¡´ ì°¨íŠ¸ ì œê±° ì¤‘ ì˜¤ë¥˜:', e);
                    }
                }
                window.scoreChart = null;
                
                // canvas ìš”ì†Œ í™•ì¸
                const canvasElement = document.getElementById('scoreChart');
                if (!canvasElement) {
                    console.error('âš ï¸ scoreChart canvas ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const scoreCtx = canvasElement.getContext('2d');
                if (!scoreCtx) {
                    console.error('âš ï¸ canvas contextë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
            
                if (!history || history.length === 0) {
                    // ë°ì´í„°ê°€ ì—†ì„ ë•Œ ë¹ˆ ê·¸ë˜í”„ í‘œì‹œ
                    window.scoreChart = new Chart(scoreCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'ì ìˆ˜',
                            data: [],
                            borderColor: '#94a3b8',
                            backgroundColor: 'rgba(148, 163, 184, 0.1)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: 'ì•„ì§ ê²½ê¸° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤',
                                color: '#8b949e'
                            }
                        }
                    }
                });
                return;
            }
            
            // ìµœì‹  ê²½ê¸°ê°€ ì˜¤ë¥¸ìª½ì— ì˜¤ë„ë¡ ì—­ìˆœ ì •ë ¬
            history.reverse();
            
            // ì‹¤ì œ ì ìˆ˜ ì¶”ì¶œ
            const scores = [];
            const labels = [];
            let gameNumber = 1;
            
            history.forEach((game) => {
                // score_afterê°€ ìˆìœ¼ë©´ ì‹¤ì œ ì ìˆ˜, ì—†ìœ¼ë©´ ìŠ¤í‚µ
                if (game.score_after) {
                    scores.push(game.score_after);
                    labels.push(gameNumber.toString());
                    gameNumber++;
                }
            });
            
            if (scores.length === 0) {
                // score ë°ì´í„°ê°€ ì—†ì„ ë•Œ
                window.scoreChart = new Chart(scoreCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'ì ìˆ˜',
                            data: [],
                            borderColor: '#94a3b8',
                            backgroundColor: 'rgba(148, 163, 184, 0.1)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: 'ì ìˆ˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤ (í”„ë¡œê·¸ë¨ì„ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”)',
                                color: '#f85149'
                            }
                        }
                    }
                });
                return;
            }
            
            // ì ìˆ˜ ê·¸ë˜í”„ ë Œë”ë§
            window.scoreChart = new Chart(scoreCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì ìˆ˜',
                        data: scores,
                        borderColor: '#58a6ff',
                        backgroundColor: 'rgba(88, 166, 255, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'ì ìˆ˜: ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'ê²½ê¸°',
                                color: '#8b949e',
                                font: { size: 12 }
                            },
                            ticks: { 
                                color: '#8b949e', 
                                maxTicksLimit: 20
                            },
                            grid: { color: '#30363d' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ì ìˆ˜',
                                color: '#8b949e',
                                font: { size: 12 }
                            },
                            ticks: { 
                                color: '#8b949e',
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            grid: { color: '#30363d' }
                        }
                    }
                }
            });
            
            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.textContent.includes(limit + 'ê²½ê¸°')) {
                    btn.classList.add('active');
                } else if (btn.textContent.includes('ê²½ê¸°')) {
                    btn.classList.remove('active');
                }
            });
            } catch (error) {
                console.error('ì ìˆ˜ ê·¸ë˜í”„ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹ˆ ê·¸ë˜í”„ í‘œì‹œ
                const canvasElement = document.getElementById('scoreChart');
                if (canvasElement) {
                    const scoreCtx = canvasElement.getContext('2d');
                    if (scoreCtx && window.scoreChart && typeof window.scoreChart.destroy === 'function') {
                        try {
                            window.scoreChart.destroy();
                        } catch (e) {}
                    }
                    window.scoreChart = new Chart(scoreCtx, {
                        type: 'line',
                        data: { labels: [], datasets: [] },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'ê·¸ë˜í”„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
                                    color: '#f85149'
                                }
                            }
                        }
                    });
                }
            }
        }
        
        // ê´€ë¦¬ì íŒ¨ë„ (Egress ìµœì í™”: í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ + ìºì‹±)
        async function loadAdminPanel(forceRefresh = false) {
            const now = Date.now();
            
            // ìºì‹œ í™•ì¸
            let users = cachedAdminPanel;
            if (forceRefresh || !cachedAdminPanel || now - lastAdminPanelLoad > ADMIN_CACHE_TIME) {
                // updated_at ì œê±°ëœ ì¿¼ë¦¬ (400 ì—ëŸ¬ ë°©ì§€) - ë°°ì—´ í˜•ì‹ìœ¼ë¡œ ëª…ì‹œì  ì§€ì •
                console.log('[AdminPanel] ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹œì‘ (updated_at ì œì™¸)');
                // ë°°ì—´ í˜•ì‹ìœ¼ë¡œ ì»¬ëŸ¼ ì§€ì • (ë¸Œë¼ìš°ì € ìºì‹œ ë¬¸ì œ ë°©ì§€)
                const columns = ['username', 'status', 'created_at', 'last_login', 'is_admin'];
                const { data: freshUsers, error } = await _supabase.from('user_accounts')
                    .select(columns.join(','));
                
                if (error) {
                    console.error('[AdminPanel] ì¿¼ë¦¬ ì˜¤ë¥˜:', error);
                    console.error('[AdminPanel] ì˜¤ë¥˜ ìƒì„¸:', JSON.stringify(error, null, 2));
                    // ì—ëŸ¬ ë°œìƒ ì‹œ ì „ì²´ ì»¬ëŸ¼ ì„ íƒìœ¼ë¡œ í´ë°± (ì—ëŸ¬ í•¸ë“¤ë§)
                    console.log('[AdminPanel] í´ë°±: ì „ì²´ ì»¬ëŸ¼ ì„ íƒ ì‹œë„');
                    const { data: fallbackUsers, error: fallbackError } = await _supabase.from('user_accounts')
                        .select('*');
                    if (fallbackError) {
                        console.error('[AdminPanel] í´ë°± ë¡œë“œë„ ì‹¤íŒ¨:', fallbackError);
                        alert('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + fallbackError.message);
                        return;
                    }
                    users = fallbackUsers;
                    console.log('[AdminPanel] í´ë°± ì„±ê³µ:', fallbackUsers?.length, 'ëª…');
                } else {
                    users = freshUsers;
                    console.log('[AdminPanel] ë¡œë“œ ì„±ê³µ:', freshUsers?.length, 'ëª…');
                }
                cachedAdminPanel = users;
                lastAdminPanelLoad = now;
            }
            
            if (users) {
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('pendingUsers').textContent = users.filter(u => u.status === 'pending').length;
                document.getElementById('approvedUsers').textContent = users.filter(u => u.status === 'approved').length;
                
                const today = getTodayKST();
                const activeToday = users.filter(u => u.last_login && u.last_login.startsWith(today)).length;
                document.getElementById('activeToday').textContent = activeToday;
                
                // ìŠ¹ì¸ ëŒ€ê¸°
                const pendingBody = document.getElementById('pendingUsersBody');
                pendingBody.innerHTML = '';
                const pending = users.filter(u => u.status === 'pending');
                
                if (pending.length === 0) {
                    pendingBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#8b949e;">ì—†ìŒ</td></tr>';
                } else {
                    pending.forEach(user => {
                        const createdDate = formatDateKST(user.created_at);
                        pendingBody.innerHTML += `
                            <tr>
                                <td><strong>${user.username}</strong></td>
                                <td>${createdDate}</td>
                                <td class="action-buttons">
                                    <button class="btn-approve" onclick="approveUser('${user.username}')">âœ“</button>
                                    <button class="btn-reject" onclick="rejectUser('${user.username}')">âœ—</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                // ìŠ¹ì¸ëœ íšŒì›
                const approvedBody = document.getElementById('approvedUsersBody');
                approvedBody.innerHTML = '';
                const approved = users.filter(u => u.status === 'approved');
                
                approved.forEach(user => {
                    const lastLogin = formatDateKST(user.last_login);
                    approvedBody.innerHTML += `
                        <tr>
                            <td><strong>${user.username}</strong>${user.is_admin ? ' ğŸ‘‘' : ''}</td>
                            <td>${lastLogin}</td>
                            <td class="action-buttons">
                                ${!user.is_admin ? `
                                    <button class="btn-suspend" onclick="suspendUser('${user.username}')">â¸</button>
                                    <button class="btn-delete" onclick="deleteUser('${user.username}')">ğŸ—‘</button>
                                ` : '<span style="color:#8b949e;">ê´€ë¦¬ì</span>'}
                            </td>
                        </tr>
                    `;
                });
                
                // ì •ì§€ëœ íšŒì›
                const suspendedBody = document.getElementById('suspendedUsersBody');
                suspendedBody.innerHTML = '';
                const suspended = users.filter(u => u.status === 'suspended');
                
                if (suspended.length === 0) {
                    suspendedBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#8b949e;">ì—†ìŒ</td></tr>';
                } else {
                    suspended.forEach(user => {
                        const suspendedDate = formatDateKST(user.updated_at || user.created_at);
                        suspendedBody.innerHTML += `
                            <tr>
                                <td><strong>${user.username}</strong></td>
                                <td>${suspendedDate}</td>
                                <td class="action-buttons">
                                    <button class="btn-approve" onclick="restoreUser('${user.username}')">âœ“ ë³µê·€</button>
                                    <button class="btn-delete" onclick="deleteUser('${user.username}')">ğŸ—‘</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                // ê±°ë¶€ëœ íšŒì›
                const rejectedBody = document.getElementById('rejectedUsersBody');
                rejectedBody.innerHTML = '';
                const rejected = users.filter(u => u.status === 'rejected');
                
                if (rejected.length === 0) {
                    rejectedBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#8b949e;">ì—†ìŒ</td></tr>';
                } else {
                    rejected.forEach(user => {
                        const rejectedDate = formatDateKST(user.updated_at || user.created_at);
                        rejectedBody.innerHTML += `
                            <tr>
                                <td><strong>${user.username}</strong></td>
                                <td>${rejectedDate}</td>
                                <td class="action-buttons">
                                    <button class="btn-approve" onclick="restoreUser('${user.username}')">âœ“ ë³µê·€</button>
                                    <button class="btn-delete" onclick="deleteUser('${user.username}')">ğŸ—‘</button>
                                </td>
                            </tr>
                        `;
                    });
                }
            }
        }
        
        async function approveUser(username) {
            if (!confirm(`'${username}' ìŠ¹ì¸?`)) return;
            
            try {
                const { data, error } = await _supabase.from('user_accounts').update({
                    status: 'approved',
                    approved_at: new Date().toISOString(),
                    approved_by: currentUser
                }).eq('username', username);
                
                if (error) throw error;
                
                alert('âœ… ìŠ¹ì¸ ì™„ë£Œ!');
                cachedAdminPanel = null; // ìºì‹œ ë¬´íš¨í™”
                await loadAdminPanel(true);
                
            } catch (error) {
                console.error('ìŠ¹ì¸ ì˜¤ë¥˜:', error);
                alert('âŒ ìŠ¹ì¸ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        async function rejectUser(username) {
            if (!confirm(`'${username}' ê±°ë¶€?`)) return;
            
            try {
                const { error } = await _supabase.from('user_accounts').update({ 
                    status: 'rejected' 
                }).eq('username', username);
                
                if (error) throw error;
                
                alert('âœ… ê±°ë¶€ ì™„ë£Œ');
                cachedAdminPanel = null; // ìºì‹œ ë¬´íš¨í™”
                await loadAdminPanel(true);
                
            } catch (error) {
                console.error('ê±°ë¶€ ì˜¤ë¥˜:', error);
                alert('âŒ ê±°ë¶€ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        async function suspendUser(username) {
            if (!confirm(`'${username}' ì •ì§€?`)) return;
            
            try {
                const { error } = await _supabase.from('user_accounts').update({ 
                    status: 'suspended' 
                }).eq('username', username);
                
                if (error) throw error;
                
                alert('âœ… ì •ì§€ ì™„ë£Œ');
                cachedAdminPanel = null; // ìºì‹œ ë¬´íš¨í™”
                await loadAdminPanel(true);
                
            } catch (error) {
                console.error('ì •ì§€ ì˜¤ë¥˜:', error);
                alert('âŒ ì •ì§€ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        async function deleteUser(username) {
            if (!confirm(`'${username}' ì‚­ì œ?\ní†µê³„ë„ ì‚­ì œë©ë‹ˆë‹¤!`)) return;
            
            try {
                // í†µê³„ ì‚­ì œ
                const { error: statsError } = await _supabase.from('game_stats').delete().eq('username', username);
                if (statsError) throw statsError;
                
                // ê³„ì • ì‚­ì œ
                const { error: userError } = await _supabase.from('user_accounts').delete().eq('username', username);
                if (userError) throw userError;
                
                alert('âœ… ì‚­ì œ ì™„ë£Œ');
                cachedAdminPanel = null; // ìºì‹œ ë¬´íš¨í™”
                await loadAdminPanel(true);
                
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        async function restoreUser(username) {
            if (!confirm(`'${username}' ë³µê·€ (ìŠ¹ì¸ ìƒíƒœë¡œ ë³€ê²½)?`)) return;
            
            try {
                const { error } = await _supabase.from('user_accounts').update({
                    status: 'approved',
                    approved_at: new Date().toISOString(),
                    approved_by: currentUser
                }).eq('username', username);
                
                if (error) throw error;
                
                alert('âœ… ë³µê·€ ì™„ë£Œ! í•´ë‹¹ ì‚¬ìš©ìëŠ” ë‹¤ì‹œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                cachedAdminPanel = null; // ìºì‹œ ë¬´íš¨í™”
                await loadAdminPanel(true);
                
            } catch (error) {
                console.error('ë³µê·€ ì˜¤ë¥˜:', error);
                alert('âŒ ë³µê·€ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // ì—…ë°ì´íŠ¸ ëª©ë¡ ë¡œë“œ (Egress ìµœì í™”: ìºì‹± + í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ + ëŒ“ê¸€ ì§€ì—° ë¡œë“œ)
        async function loadUpdates(forceRefresh = false) {
            const now = Date.now();
            const list = document.getElementById('updatesList');
            
            // ìºì‹œ í™•ì¸
            let updates = cachedUpdates;
            if (forceRefresh || !cachedUpdates || now - lastUpdatesLoad > UPDATES_CACHE_TIME) {
                // [Egress ìµœì í™”] ìµœì‹  20ê°œë§Œ ë¡œë“œ
                const { data: freshUpdates } = await _supabase
                    .from('updates')
                    .select('id, version, title, content, created_at, created_by, download_url')
                    .order('created_at', { ascending: false })
                    .limit(20);
                updates = freshUpdates;
                cachedUpdates = freshUpdates;
                lastUpdatesLoad = now;
            }
            
            if (!updates || updates.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#8b949e;padding:40px;">ì•„ì§ ì—…ë°ì´íŠ¸ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            list.innerHTML = updates.map(update => `
                <div style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <span style="background: #3a3a3a; color: #e0e0e0; padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; margin-right: 10px; border: 1px solid #4a4a4a;">
                                ${update.version || 'v1.0.0'}
                            </span>
                            <span style="color: #e0e0e0; font-size: 18px; font-weight: bold;">
                                ${update.title}
                            </span>
                        </div>
                        ${isAdmin ? `
                            <div style="display: flex; gap: 8px;">
                                <button onclick="editUpdate(${update.id}, '${update.version?.replace(/'/g, "\\'")}', '${update.title.replace(/'/g, "\\'")}', \`${update.content.replace(/`/g, '\\`')}\`, '${update.download_url || ''}')" 
                                    style="background: #3a3a3a; color: #e0e0e0; border: 1px solid #4a4a4a; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    âœï¸ ìˆ˜ì •
                                </button>
                                <button onclick="deleteUpdate(${update.id})" 
                                    style="background: #f85149; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    ğŸ—‘ï¸ ì‚­ì œ
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div style="color: #808080; font-size: 12px; margin-bottom: 15px;">
                        ${new Date(update.created_at).toLocaleString('ko-KR')} Â· ${update.created_by}
                    </div>
                    <div style="color: #b4b4b4; line-height: 1.6; white-space: pre-wrap; margin-bottom: 15px;">
                        ${update.content}
                    </div>
                    ${update.download_url ? `
                        <a href="${update.download_url}" target="_blank" 
                            style="display: inline-block; background: linear-gradient(135deg, #238636 0%, #2ea043 100%); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 14px; transition: transform 0.2s; margin-bottom: 15px;"
                            onmouseover="this.style.transform='translateY(-2px)'" 
                            onmouseout="this.style.transform='translateY(0)'">
                            ğŸ“¥ ë‹¤ìš´ë¡œë“œ
                        </a>
                    ` : ''}
                    
                    <div style="border-top: 1px solid #30363d; padding-top: 15px; margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="color: #8b949e; font-size: 14px;">ğŸ’¬ ëŒ“ê¸€</div>
                            <button onclick="toggleComments(${update.id})" id="toggleBtn-${update.id}"
                                style="background: #3a3a3a; color: #e0e0e0; border: 1px solid #4a4a4a; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 11px;">
                                ë³´ê¸°
                            </button>
                        </div>
                        <div id="commentsContainer-${update.id}" style="display: none;">
                            <div id="comments-${update.id}" style="margin-bottom: 10px;"></div>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="commentInput-${update.id}" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                                    style="flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid #30363d; background: #161b22; color: #c9d1d9; font-size: 13px;">
                                <button onclick="postComment(${update.id})" 
                                    style="background: #238636; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                                    ëŒ“ê¸€ ì‘ì„±
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // ëŒ“ê¸€ì€ ì§€ì—° ë¡œë“œ (ì´ˆê¸° ë¡œë“œ ì•ˆ í•¨)
        }
        
        // ëŒ“ê¸€ í† ê¸€ í•¨ìˆ˜ (ì§€ì—° ë¡œë“œ)
        let loadedComments = new Set();
        async function toggleComments(updateId) {
            const container = document.getElementById(`commentsContainer-${updateId}`);
            const toggleBtn = document.getElementById(`toggleBtn-${updateId}`);
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                toggleBtn.textContent = 'ìˆ¨ê¸°ê¸°';
                
                // ëŒ“ê¸€ì„ ì•„ì§ ë¡œë“œí•˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¡œë“œ
                if (!loadedComments.has(updateId)) {
                    await loadComments(updateId);
                    loadedComments.add(updateId);
                }
            } else {
                container.style.display = 'none';
                toggleBtn.textContent = 'ë³´ê¸°';
            }
        }
        
        // ì—…ë°ì´íŠ¸ ê²Œì‹œ
        // ì—…ë°ì´íŠ¸ ê²Œì‹œ/ìˆ˜ì • í•¨ìˆ˜
        async function postUpdate() {
            const version = document.getElementById('updateVersion').value.trim();
            const title = document.getElementById('updateTitle').value.trim();
            const content = document.getElementById('updateContent').value.trim();
            const downloadUrl = document.getElementById('updateDownloadUrl').value.trim();
            
            if (!version || !title || !content) {
                alert('âš ï¸ ë²„ì „, ì œëª©, ë‚´ìš©ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤!');
                return;
            }
            
            try {
                if (editingUpdateId) {
                    // ìˆ˜ì • ëª¨ë“œ
                    const { error } = await _supabase.from('updates')
                        .update({
                            version,
                            title,
                            content,
                            download_url: downloadUrl || null
                        })
                        .eq('id', editingUpdateId);
                    
                    if (error) throw error;
                    alert('âœ… ì—…ë°ì´íŠ¸ ê³µì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    editingUpdateId = null;
                } else {
                    // ë“±ë¡ ëª¨ë“œ
                    const updateData = {
                        version,
                        title,
                        content,
                        created_by: currentUser,
                        download_url: downloadUrl || null
                    };
                    
                    const { error } = await _supabase.from('updates').insert(updateData);
                    
                    if (error) throw error;
                    alert('âœ… ì—…ë°ì´íŠ¸ ê³µì§€ê°€ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
                
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                cancelEdit();
                cachedUpdates = null; // ìºì‹œ ë¬´íš¨í™”
                await loadUpdates(true);
                
            } catch (error) {
                alert('âŒ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // ìˆ˜ì • ì·¨ì†Œ ë° í¼ ì´ˆê¸°í™”
        function cancelEdit() {
            editingUpdateId = null;
            document.getElementById('updateVersion').value = '';
            document.getElementById('updateTitle').value = '';
            document.getElementById('updateContent').value = '';
            document.getElementById('updateDownloadUrl').value = '';
            
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì›ë˜ëŒ€ë¡œ
            const btn = document.getElementById('postUpdateBtn');
            if (btn) {
                btn.textContent = 'ğŸ“¤ ê²Œì‹œí•˜ê¸°';
                btn.style.background = '#238636';
            }
        }
        
        // ì—…ë°ì´íŠ¸ ìˆ˜ì • (í¼ì— ë°ì´í„° ë„£ê¸°)
        let editingUpdateId = null;
        
        function editUpdate(id, version, title, content, downloadUrl) {
            editingUpdateId = id;
            
            // í¼ì— ê¸°ì¡´ ë°ì´í„° ë„£ê¸°
            document.getElementById('updateVersion').value = version || '';
            document.getElementById('updateTitle').value = title || '';
            document.getElementById('updateContent').value = content || '';
            document.getElementById('updateDownloadUrl').value = downloadUrl || '';
            
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            const btn = document.getElementById('postUpdateBtn');
            if (btn) {
                btn.textContent = 'âœï¸ ìˆ˜ì • ì™„ë£Œ';
                btn.style.background = '#3a3a3a';
            }
            
            // ìŠ¤í¬ë¡¤ ì´ë™ (ì‘ì„± í¼ìœ¼ë¡œ)
            document.getElementById('updateWriteForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // ì—…ë°ì´íŠ¸ ì‚­ì œ
        async function deleteUpdate(id) {
            if (!confirm('ì´ ì—…ë°ì´íŠ¸ ê³µì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const { error } = await _supabase.from('updates').delete().eq('id', id);
                
                if (error) throw error;
                
                alert('âœ… ì‚­ì œ ì™„ë£Œ');
                cachedUpdates = null; // ìºì‹œ ë¬´íš¨í™”
                await loadUpdates(true);
                
            } catch (error) {
                alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // ë­í‚¹ ë¡œë“œ (ì˜¤ëŠ˜ì˜ ìŠ¹ìˆ˜ ìˆœìœ„)
        // ë­í‚¹ íƒ€ì… ì „í™˜
        // ëŒ“ê¸€ ë¡œë“œ
        async function loadComments(updateId) {
            try {
                // [Egress ìµœì í™”] í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ (select '*' ëŒ€ì‹ )
                const { data: comments } = await _supabase
                    .from('update_comments')
                    .select('username, comment, created_at')
                    .eq('update_id', updateId)
                    .order('created_at', { ascending: true });
                
                const container = document.getElementById(`comments-${updateId}`);
                
                if (!comments || comments.length === 0) {
                    container.innerHTML = '<div style="color: #8b949e; font-size: 12px; padding: 10px 0;">ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</div>';
                    return;
                }
                
                container.innerHTML = comments.map(comment => `
                    <div style="background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="color: #58a6ff; font-weight: bold; font-size: 13px;">${comment.username}</span>
                            <span style="color: #8b949e; font-size: 11px;">${new Date(comment.created_at).toLocaleString('ko-KR')}</span>
                        </div>
                        <div style="color: #c9d1d9; font-size: 13px; line-height: 1.4;">${comment.comment}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('ëŒ“ê¸€ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ëŒ“ê¸€ ì‘ì„±
        async function postComment(updateId) {
            const input = document.getElementById(`commentInput-${updateId}`);
            const comment = input.value.trim();
            
            if (!comment) {
                alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!');
                return;
            }
            
            try {
                const { error } = await _supabase
                    .from('update_comments')
                    .insert({
                        update_id: updateId,
                        username: currentUser,
                        comment: comment
                    });
                
                if (error) throw error;
                
                input.value = '';
                // ëŒ“ê¸€ë§Œ ìƒˆë¡œê³ ì¹¨ (ì—…ë°ì´íŠ¸ ëª©ë¡ì€ ê·¸ëŒ€ë¡œ)
                await loadComments(updateId);
                
            } catch (error) {
                console.error('ëŒ“ê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
                alert('ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // ê³µì§€ì‚¬í•­ ë¡œë“œ
        async function loadAnnouncements() {
            try {
                // [Egress ìµœì í™”] í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ (select '*' ëŒ€ì‹ )
                const { data: announcements } = await _supabase
                    .from('announcements')
                    .select('id, message, type, created_by')
                    .eq('active', true)
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                const banner = document.getElementById('announcementBanner');
                
                if (!announcements || announcements.length === 0) {
                    banner.style.display = 'none';
                    return;
                }
                
                const announcement = announcements[0];
                const colors = {
                    info: { bg: '#1a2e3a', border: '#2a5a7a', text: '#58a6ff' },
                    success: { bg: '#1a2e26', border: '#2d4a3e', text: '#86efac' },
                    warning: { bg: '#2e2a1a', border: '#4a422d', text: '#fcd34d' },
                    error: { bg: '#2e1a1a', border: '#4a2d2d', text: '#fca5a5' }
                };
                
                const color = colors[announcement.type] || colors.info;
                
                banner.innerHTML = `
                    <div style="background: ${color.bg}; border: 1px solid ${color.border}; 
                                border-radius: 12px; padding: 15px 20px; margin-bottom: 20px; 
                                display: flex; align-items: center; justify-content: space-between;">
                        <div style="color: ${color.text}; font-weight: 600; flex: 1;">
                            ${announcement.message}
                        </div>
                        ${isAdmin ? `
                            <button onclick="deleteAnnouncement(${announcement.id})" 
                                    style="background: transparent; border: 1px solid ${color.border}; 
                                           color: ${color.text}; padding: 6px 12px; border-radius: 6px; 
                                           cursor: pointer; margin-left: 15px; font-size: 12px;">
                                ì‚­ì œ
                            </button>
                        ` : ''}
                    </div>
                `;
                banner.style.display = 'block';
                
            } catch (error) {
                console.error('ê³µì§€ì‚¬í•­ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ê³µì§€ì‚¬í•­ ì‘ì„± (ê´€ë¦¬ìë§Œ)
        async function createAnnouncement() {
            if (!isAdmin) {
                alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const message = document.getElementById('announcementInput').value.trim();
            const type = document.getElementById('announcementType').value;
            
            if (!message) {
                alert('ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”!');
                return;
            }
            
            try {
                // ê¸°ì¡´ ê³µì§€ ë¹„í™œì„±í™”
                await _supabase
                    .from('announcements')
                    .update({ active: false })
                    .eq('active', true);
                
                // ìƒˆ ê³µì§€ ìƒì„±
                const { error } = await _supabase
                    .from('announcements')
                    .insert({
                        message: message,
                        type: type,
                        created_by: currentUser,
                        active: true
                    });
                
                if (error) throw error;
                
                alert('âœ… ê³µì§€ê°€ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!');
                document.getElementById('announcementInput').value = '';
                document.getElementById('announcementType').value = 'info';
                loadAnnouncements();
                
            } catch (error) {
                console.error('ê³µì§€ ì‘ì„± ì˜¤ë¥˜:', error);
                alert('âŒ ê³µì§€ ì‘ì„± ì‹¤íŒ¨: ' + error.message);
            }
        }
        
        // ê³µì§€ì‚¬í•­ ì‚­ì œ (ê´€ë¦¬ìë§Œ)
        async function deleteAnnouncement(id) {
            if (!isAdmin) {
                alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm('ì´ ê³µì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const { error } = await _supabase
                    .from('announcements')
                    .update({ active: false })
                    .eq('id', id);
                
                if (error) throw error;
                
                alert('ì‚­ì œ ì™„ë£Œ');
                loadAnnouncements();
                
            } catch (error) {
                console.error('ê³µì§€ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }
    </script>
</body>
</html>