<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Function - 게임 통계 시스템</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: #0f0f0f;
            min-height: 100vh;
            padding: 10px;
            color: #b4b4b4;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* 로그인 화면 */
        .login-container {
            max-width: 450px;
            margin: 100px auto;
            background: #1a1a1a;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
            border: 1px solid #2a2a2a;
        }
        .login-container h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #e0e0e0;
            font-size: 28px;
        }
        .login-container input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
            background: #141414;
            color: #b4b4b4;
            font-size: 16px;
        }
        .login-container label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            color: #808080;
            cursor: pointer;
        }
        .login-container input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        .login-container button {
            width: 100%;
            padding: 15px;
            margin: 15px 0 5px 0;
            border-radius: 8px;
            border: none;
            background: #3a3a3a;
            color: #e0e0e0;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .login-container button:hover { background: #4a4a4a; transform: translateY(-2px); }
        
        /* 메인 화면 */
        .main-view { display: none; }
        .main-view.active { display: block; }
        
        /* 헤더 */
        .header {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 18px 25px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .header h1 { 
            color: #e0e0e0;
            font-size: 22px;
            font-weight: 700;
        }
        .header-right { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .username-badge {
            background: #3a3a3a;
            color: #e0e0e0;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        .admin-badge {
            background: #4a4a4a;
            color: #e0e0e0;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 5px;
        }
        .logout-btn {
            background: #f85149;
            color: white;
            padding: 6px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        .logout-btn:hover { background: #da3633; }
        
        /* 미니창 스타일 실시간 정보 */
        .live-mini-window {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .live-mini-window h2 {
            color: #e0e0e0;
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }
        .mini-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        .mini-stat-box {
            background: #141414;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s;
        }
        .mini-stat-box:hover { 
            transform: translateY(-3px); 
            border-color: #3a3a3a;
            background: #1a1a1a;
        }
        .mini-stat-title {
            color: #808080;
            font-size: 12px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .mini-stat-value {
            color: #b4b4b4;
            font-size: 24px;
            font-weight: bold;
        }
        .mini-status-bar {
            background: #141414;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            text-align: center;
        }
        .mini-status-text {
            color: #808080;
            font-size: 14px;
        }
        .mini-status-text.in-game {
            color: #86efac;
            font-weight: bold;
        }
        .mini-tags {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .mini-tag {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #e0e0e0;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .mini-tag:hover {
            background: #3a3a3a;
            border-color: #4a4a4a;
            transform: translateY(-1px);
        }
        
        /* 탭 */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .tab-btn {
            padding: 12px 24px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            color: #808080;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 14px;
        }
        .tab-btn:hover { 
            background: #202020;
            color: #b4b4b4;
            border-color: #3a3a3a;
        }
        .tab-btn.active { 
            background: #2a2a2a;
            color: #e0e0e0;
            border-color: #4a4a4a;
        }
        
        /* 카드 */
        .card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        .card:hover {
            border-color: #3a3a3a;
        }
        .card h2 { 
            color: #e0e0e0; 
            margin-bottom: 20px; 
            font-size: 20px;
            font-weight: 600;
        }
        
        /* 통계 그리드 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box {
            text-align: center;
            padding: 20px 15px;
            background: #202020;
            border: 1px solid #3a3a3a;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .stat-box:hover { 
            transform: translateY(-3px); 
            background: #2a2a2a;
            border-color: #4a4a4a;
        }
        .stat-value { 
            font-size: 36px; 
            font-weight: bold; 
            color: #e0e0e0;
        }
        .stat-label { 
            font-size: 13px; 
            margin-top: 8px; 
            color: #808080;
            font-weight: 500;
        }
        
        /* 색상 변형 */
        .stat-box.green { 
            background: #1a2e26;
            border-color: #2d4a3e;
        }
        .stat-box.green:hover { 
            background: #1e3a2e;
            border-color: #3a5a4d;
        }
        .stat-box.green .stat-value { 
            color: #86efac;
        }
        
        .stat-box.red { 
            background: #2e1a1a;
            border-color: #4a2d2d;
        }
        .stat-box.red:hover { 
            background: #3a1e1e;
            border-color: #5a3a3a;
        }
        .stat-box.red .stat-value { 
            color: #fca5a5;
        }
        
        .stat-box.yellow { 
            background: #2e2a1a;
            border-color: #4a422d;
        }
        .stat-box.yellow:hover { 
            background: #3a341e;
            border-color: #5a523a;
        }
        .stat-box.yellow .stat-value { 
            color: #fcd34d;
        }
        
        .stat-box.purple { 
            background: #251a2e;
            border-color: #3d2d4a;
        }
        .stat-box.purple:hover { 
            background: #2e1e3a;
            border-color: #4d3a5a;
        }
        .stat-box.purple .stat-value { 
            color: #c4b5fd;
        }
        
        .stat-box.orange { 
            background: #2e221a;
            border-color: #4a382d;
        }
        .stat-box.orange:hover { 
            background: #3a2a1e;
            border-color: #5a483a;
        }
        .stat-box.orange .stat-value { 
            color: #fdba74;
        }
        
        /* 테이블 */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border-radius: 10px;
            background: #141414;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #2a2a2a;
        }
        th {
            background: #202020;
            color: #b4b4b4;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        tr:hover { 
            background: #1a1a1a;
            transition: all 0.2s ease;
        }
        
        /* 랭킹 */
        .rank-1 { background: #ffd700 !important; color: #000 !important; font-weight: bold; }
        .rank-2 { background: #c0c0c0 !important; color: #000 !important; font-weight: bold; }
        .rank-3 { background: #cd7f32 !important; color: #000 !important; font-weight: bold; }
        .me-row { outline: 3px solid #1f6feb; }
        
        /* 상태 배지 */
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending { background: #d29922; color: #000; }
        .status-approved { background: #238636; color: white; }
        .status-rejected { background: #f85149; color: white; }
        .status-suspended { background: #8b949e; color: white; }
        
        /* 액션 버튼 */
        .action-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        .action-buttons button {
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn-approve { background: #238636; color: white; }
        .btn-approve:hover { background: #2ea043; }
        .btn-reject { background: #f85149; color: white; }
        .btn-reject:hover { background: #da3633; }
        .btn-suspend { background: #d29922; color: white; }
        .btn-suspend:hover { background: #b58318; }
        .btn-delete { background: #8b949e; color: white; }
        .btn-delete:hover { background: #6e7681; }
        
        /* 차트 */
        #chartContainer { height: 250px; margin: 15px 0; }
        
        /* 메시지 */
        .message {
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 14px;
        }
        .error { background: #ff4444; color: white; }
        .success { background: #00C851; color: white; }
        .warning { background: #ffbb33; color: #000; }
        
        /* 탭 컨텐츠 */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* 모바일 최적화 */
        @media (max-width: 768px) {
            body { padding: 5px; }
            .header { padding: 10px; }
            .header h1 { font-size: 16px; }
            .login-container { margin: 50px auto; padding: 25px; }
            .card { padding: 15px; }
            .stat-value { font-size: 28px; }
            .mini-stat-value { font-size: 20px; }
            table { font-size: 12px; }
            th, td { padding: 8px 5px; }
            .tabs { gap: 5px; }
            .tab-btn { padding: 8px 15px; font-size: 13px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 로그인/회원가입 화면 -->
        <div class="login-container" id="loginContainer">
            <h1>⚡ Function</h1>
            
            <!-- 로그인/회원가입 전환 버튼 -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button id="showLoginBtn" onclick="showLoginForm()" style="flex: 1; background: #1f6feb;">로그인</button>
                <button id="showSignupBtn" onclick="showSignupForm()" style="flex: 1; background: #30363d;">회원가입</button>
            </div>
            
            <!-- 로그인 폼 -->
            <div id="loginForm">
                <input type="text" id="loginUsername" placeholder="사용자명">
                <input type="password" id="loginPassword" placeholder="비밀번호">
                <label>
                    <input type="checkbox" id="autoLoginCheck" checked>
                    <span>자동 로그인</span>
                </label>
                <button onclick="login()">로그인</button>
            </div>
            
            <!-- 회원가입 폼 -->
            <div id="signupForm" style="display: none;">
                <div style="color: #58a6ff; font-size: 13px; margin-bottom: 15px; padding: 10px; background: rgba(88, 166, 255, 0.1); border-radius: 6px; border: 1px solid #30363d;">
                    ⚽ <strong>아이디는 피파 닉네임으로 입력하세요</strong>
                </div>
                <input type="text" id="signupUsername" placeholder="피파 닉네임 (2-20자, 한글/영어/숫자)">
                <input type="password" id="signupPassword" placeholder="비밀번호 (6-12자)">
                <input type="password" id="signupPasswordConfirm" placeholder="비밀번호 확인">
                <div style="color: #8b949e; font-size: 12px; margin: 10px 0; line-height: 1.5;">
                    ⚠️ 비밀번호 조건:<br>
                    • 6~12자<br>
                    • 영어, 숫자, 특수문자 중 2가지 이상 포함
                </div>
                <button onclick="signup()">회원가입</button>
            </div>
            
            <div id="loginMessage"></div>
        </div>
        
        <!-- 메인 화면 -->
        <div class="main-view" id="mainView">
            <!-- 헤더 -->
            <div class="header">
                <h1>⚡ Function</h1>
                <div class="header-right">
                    <span class="username-badge">
                        <span id="headerUsername"></span>
                        <span id="adminBadge" style="display:none;" class="admin-badge">관리자</span>
                    </span>
                    <button class="logout-btn" onclick="logout()">로그아웃</button>
                </div>
            </div>
            
            <!-- 공지사항 배너 -->
            <div id="announcementBanner" style="display: none;"></div>
            
            <!-- 관리자 공지 작성 (관리자만 보임) -->
            <div id="announcementAdmin" style="display: none;">
                <div style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #58a6ff; margin-bottom: 15px;">📢 공지사항 작성</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="announcementInput" placeholder="공지 내용을 입력하세요..." 
                               style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #2a2a2a; background: #141414; color: #b4b4b4;">
                        <select id="announcementType" style="padding: 12px; border-radius: 8px; border: 1px solid #2a2a2a; background: #141414; color: #b4b4b4;">
                            <option value="info">ℹ️ 정보</option>
                            <option value="success">✅ 성공</option>
                            <option value="warning">⚠️ 경고</option>
                            <option value="error">🚨 중요</option>
                        </select>
                        <button onclick="createAnnouncement()" 
                                style="padding: 12px 24px; background: #238636; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            게시
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 실시간 미니 정보 -->
            <div class="live-mini-window">
                <h2>📡 실시간 정보</h2>
                <div class="mini-stats-grid">
                    <div class="mini-stat-box">
                        <div class="mini-stat-title">점수</div>
                        <div class="mini-stat-value" id="liveScore">--</div>
                    </div>
                    <div class="mini-stat-box">
                        <div class="mini-stat-title">등수</div>
                        <div class="mini-stat-value" id="liveRank">--</div>
                    </div>
                    <div class="mini-stat-box">
                        <div class="mini-stat-title">티어</div>
                        <div class="mini-stat-value" id="liveTier" style="font-size: 14px;">--</div>
                    </div>
                    <div class="mini-stat-box">
                        <div class="mini-stat-title">승-무-패</div>
                        <div class="mini-stat-value" id="liveWLD" style="font-size: 16px;">0-0-0</div>
                    </div>
                    <div class="mini-stat-box">
                        <div class="mini-stat-title">채굴FC</div>
                        <div class="mini-stat-value" id="liveFC">0</div>
                    </div>
                    <div class="mini-stat-box">
                        <div class="mini-stat-title">판수</div>
                        <div class="mini-stat-value" id="liveMatches">0</div>
                    </div>
                </div>
                <div class="mini-status-bar">
                    <div class="mini-status-text" id="liveStatus">대기 중...</div>
                    <div class="mini-tags" id="liveTags"></div>
                </div>
            </div>
            
            <!-- 탭 -->
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('today')">오늘</button>
                <button class="tab-btn" onclick="showTab('week')">7일</button>
                <button class="tab-btn" onclick="showTab('history')">점수 그래프</button>
                <button class="tab-btn" onclick="showTab('matches')">🎮 전적</button>
                <button class="tab-btn" onclick="showTab('ranking')">🏆 랭킹</button>
                <button class="tab-btn" onclick="showTab('updates')">📢 업데이트</button>
                <button class="tab-btn" id="adminTabBtn" style="display:none;" onclick="showTab('admin')">👑 회원관리</button>
            </div>
            
            <!-- 오늘 탭 -->
            <div class="tab-content active" id="todayTab">
                <!-- 일일 통계 -->
                <div class="card">
                    <h2>📊 오늘의 통계</h2>
                    <div class="stats-grid">
                        <div class="stat-box" style="background: #1a2e3a; border-color: #2a5a7a;">
                            <div class="stat-value" id="todayWins" style="color: #58a6ff;">0</div>
                            <div class="stat-label">승리</div>
                        </div>
                        <div class="stat-box red">
                            <div class="stat-value" id="todayLosses">0</div>
                            <div class="stat-label">패배</div>
                        </div>
                        <div class="stat-box yellow">
                            <div class="stat-value" id="todayDraws">0</div>
                            <div class="stat-label">무승부</div>
                        </div>
                        <div class="stat-box green">
                            <div class="stat-value" id="todayFC">0</div>
                            <div class="stat-label">FC 채굴</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="todayMatches">0</div>
                            <div class="stat-label">판수</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="todayWinrate">0%</div>
                            <div class="stat-label">승률</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="todayStartScore">--</div>
                            <div class="stat-label">시작 점수</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="todayHighScore">--</div>
                            <div class="stat-label">최고 점수</div>
                        </div>
                    </div>
                </div>
                
                <!-- 슈챌→챔스 승급 정보 -->
                <div class="card" id="promotionCard" style="display: none;">
                    <h2>🏆 슈챌 → 챔스 승급</h2>
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 48px; color: #ffd700; margin-bottom: 10px;">🎉</div>
                        <div style="font-size: 24px; color: #58a6ff; font-weight: bold; margin-bottom: 10px;" id="promotionMatches">--판</div>
                        <div style="color: #8b949e; font-size: 14px;" id="promotionDate">--</div>
                    </div>
                </div>
            </div>
            
            <!-- 7일 탭 -->
            <div class="tab-content" id="weekTab">
                <div class="card">
                    <h2>📅 최근 7일 통계</h2>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>날짜</th>
                                    <th>승</th>
                                    <th>무</th>
                                    <th>패</th>
                                    <th>승률</th>
                                    <th>FC 채굴</th>
                                    <th>슈챌→챔스</th>
                                </tr>
                            </thead>
                            <tbody id="weekTableBody">
                                <tr><td colspan="7" style="text-align:center;color:#8b949e;">로딩 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 점수 그래프 탭 -->
            <div class="tab-content" id="historyTab">
                <div class="card">
                    <h2>📈 점수 그래프</h2>
                    
                    <!-- 경기 수 선택 -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        <button class="tab-btn" style="margin: 5px;" onclick="loadScoreGraph(100)">100경기</button>
                        <button class="tab-btn" style="margin: 5px;" onclick="loadScoreGraph(200)">200경기</button>
                        <button class="tab-btn" style="margin: 5px;" onclick="loadScoreGraph(300)">300경기</button>
                        <button class="tab-btn" style="margin: 5px;" onclick="loadScoreGraph(400)">400경기</button>
                        <button class="tab-btn active" style="margin: 5px;" onclick="loadScoreGraph(500)">500경기</button>
                    </div>
                    
                    <div style="height: 350px;">
                        <canvas id="scoreChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 전적 탭 -->
            <div class="tab-content" id="matchesTab">
                <div class="card">
                    <h2>🎮 최근 전적 (넥슨 API)</h2>
                    
                    <!-- 동기화 버튼 및 상태 -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <div style="color: #8b949e; font-size: 13px;">
                            <span id="lastSyncTime">마지막 동기화: -</span>
                            <br>
                            <span style="color: #fcd34d; font-size: 11px;">⚠️ 넥슨 API는 2시간 전까지의 데이터만 제공합니다</span>
                            <br>
                            <span style="color: #8b949e; font-size: 11px;">📊 감독모드 공식경기 최대 30경기까지 조회됩니다</span>
                        </div>
                        <button class="tab-btn" id="syncMatchesBtn" onclick="requestMatchSync()" style="margin: 0;">
                            🔄 전적 동기화
                        </button>
                    </div>
                    
                    <p id="syncStatus" style="color: #8b949e; font-size: 12px; margin-bottom: 15px; display: none;"></p>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>날짜</th>
                                    <th>결과</th>
                                    <th>점수</th>
                                    <th>상대</th>
                                </tr>
                            </thead>
                            <tbody id="matchesTableBody">
                                <tr><td colspan="4" style="text-align:center;color:#8b949e;">전적 데이터가 없습니다</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 랭킹 탭 -->
            <div class="tab-content" id="rankingTab">
                <div class="card">
                    <h2>🏆 랭킹</h2>
                    
                    <!-- 랭킹 타입 선택 -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <button class="tab-btn active" id="winsRankBtn" style="margin: 5px;" onclick="showRankingType('wins')">최다승 랭킹</button>
                        <button class="tab-btn" id="scoreRankBtn" style="margin: 5px;" onclick="showRankingType('score')">실시간 점수 랭킹</button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead id="rankingTableHead">
                                <tr>
                                    <th>순위</th>
                                    <th>사용자명</th>
                                    <th>승</th>
                                    <th>패</th>
                                    <th>무</th>
                                    <th>승률</th>
                                </tr>
                            </thead>
                            <tbody id="rankingTableBody">
                                <tr><td colspan="6" style="text-align:center;color:#808080;">로딩 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 업데이트 탭 -->
            <div class="tab-content" id="updatesTab">
                <div class="card">
                    <h2>📢 업데이트 공지</h2>
                    
                    <!-- 관리자만 보이는 작성 폼 -->
                    <div id="updateWriteForm" style="display:none;">
                        <div style="background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <h3 style="color: #58a6ff; margin-bottom: 15px; font-size: 16px;">✍️ 새 업데이트 작성</h3>
                            <input type="text" id="updateVersion" placeholder="버전 (예: v1.0.0)" 
                                style="width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #30363d; background: #161b22; color: #c9d1d9;">
                            <input type="text" id="updateTitle" placeholder="제목" 
                                style="width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #30363d; background: #161b22; color: #c9d1d9;">
                            <textarea id="updateContent" placeholder="업데이트 내용 (줄바꿈은 Enter로)" rows="5"
                                style="width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #30363d; background: #161b22; color: #c9d1d9; resize: vertical;"></textarea>
                            <input type="url" id="updateDownloadUrl" placeholder="다운로드 링크 (선택사항 - 구글 드라이브, GitHub 등)" 
                                style="width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #30363d; background: #161b22; color: #c9d1d9;">
                            <button onclick="publishUpdate()" 
                                style="width: 100%; padding: 12px; margin-top: 10px; background: #238636; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                                📤 게시하기
                            </button>
                        </div>
                    </div>
                    
                    <!-- 업데이트 목록 -->
                    <div id="updatesList"></div>
                </div>
            </div>
            
            <!-- 관리자 탭 -->
            <div class="tab-content" id="adminTab">
                <div class="card">
                    <h2>👑 회원 관리</h2>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="totalUsers">0</div>
                            <div class="stat-label">전체</div>
                        </div>
                        <div class="stat-box yellow">
                            <div class="stat-value" id="pendingUsers">0</div>
                            <div class="stat-label">대기</div>
                        </div>
                        <div class="stat-box green">
                            <div class="stat-value" id="approvedUsers">0</div>
                            <div class="stat-label">승인</div>
                        </div>
                        <div class="stat-box orange">
                            <div class="stat-value" id="activeToday">0</div>
                            <div class="stat-label">오늘</div>
                        </div>
                    </div>
                    
                    <h3 style="margin: 20px 0 10px 0; color: #d29922; font-size: 16px;">⏳ 승인 대기</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>사용자명</th>
                                    <th>가입일시</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="pendingUsersBody"></tbody>
                        </table>
                    </div>
                    
                    <h3 style="margin: 20px 0 10px 0; color: #238636; font-size: 16px;">✅ 승인된 회원</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>사용자명</th>
                                    <th>마지막 접속</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="approvedUsersBody"></tbody>
                        </table>
                    </div>
                    
                    <h3 style="margin: 20px 0 10px 0; color: #f85149; font-size: 16px;">⏸ 정지된 회원</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>사용자명</th>
                                    <th>정지일시</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="suspendedUsersBody"></tbody>
                        </table>
                    </div>
                    
                    <h3 style="margin: 20px 0 10px 0; color: #8b949e; font-size: 16px;">✗ 거부된 회원</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>사용자명</th>
                                    <th>거부일시</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="rejectedUsersBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const SUPABASE_URL = 'https://tmbyzravuobepzicwpqe.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtYnl6cmF2dW9iZXB6aWN3cHFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1ODg2NTksImV4cCI6MjA3NzE2NDY1OX0.XIb1VE_r3_7PHwaFSppscpIgpaJ9cuvf5t0i67OeQCg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        let isAdmin = false;
        
        // 한국 시간(KST) 기준으로 오늘 날짜 반환 (YYYY-MM-DD)
        function getTodayKST() {
            const now = new Date();
            // UTC 시간에 9시간(한국 시간대)을 더함
            const kstOffset = 9 * 60; // 9시간을 분으로 변환
            const kstTime = new Date(now.getTime() + (kstOffset * 60 * 1000));
            
            // ISO 문자열로 변환 후 날짜 부분만 추출
            return kstTime.toISOString().split('T')[0];
        }
        
        // 자동 로그인 체크
        window.onload = function() {
            const savedUsername = localStorage.getItem('function_username');
            const savedPassword = localStorage.getItem('function_password');
            
            if (savedUsername && savedPassword) {
                document.getElementById('loginUsername').value = savedUsername;
                document.getElementById('loginPassword').value = savedPassword;
                document.getElementById('autoLoginCheck').checked = true;
                login(true); // 자동 로그인
            }
        };
        
        // 로그인/회원가입 폼 전환
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('showLoginBtn').style.background = '#1f6feb';
            document.getElementById('showSignupBtn').style.background = '#30363d';
            document.getElementById('loginMessage').innerHTML = '';
        }
        
        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('showLoginBtn').style.background = '#30363d';
            document.getElementById('showSignupBtn').style.background = '#1f6feb';
            document.getElementById('loginMessage').innerHTML = '';
        }
        
        // 회원가입
        async function signup() {
            const username = document.getElementById('signupUsername').value.trim();
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
            
            if (!username || !password || !passwordConfirm) {
                showLoginMessage('모든 항목을 입력하세요.', 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                showLoginMessage('비밀번호가 일치하지 않습니다.', 'error');
                return;
            }
            
            // 사용자명 검증 (2-20자, 한글/영어/숫자만)
            if (username.length < 2 || username.length > 20) {
                showLoginMessage('사용자명은 2~20자여야 합니다.', 'error');
                return;
            }
            
            const usernameRegex = /^[가-힣a-zA-Z0-9]+$/;
            if (!usernameRegex.test(username)) {
                showLoginMessage('사용자명은 한글, 영어, 숫자만 사용 가능합니다.', 'error');
                return;
            }
            
            // 비밀번호 검증 (6-12자, 영어/숫자/특수문자 중 2가지 이상)
            if (password.length < 6 || password.length > 12) {
                showLoginMessage('비밀번호는 6~12자여야 합니다.', 'error');
                return;
            }
            
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            const complexityCount = [hasLetter, hasNumber, hasSpecial].filter(Boolean).length;
            
            if (complexityCount < 2) {
                showLoginMessage('비밀번호는 영어, 숫자, 특수문자 중 2가지 이상 포함해야 합니다.', 'error');
                return;
            }
            
            try {
                // Supabase RPC를 통한 회원가입
                const { data, error } = await supabase.rpc('signup_user', {
                    username_param: username,
                    pin_param: password
                });
                
                if (error) {
                    if (error.message.includes('이미 존재')) {
                        showLoginMessage('이미 존재하는 사용자명입니다.', 'error');
                    } else {
                        showLoginMessage('회원가입 실패: ' + error.message, 'error');
                    }
                    return;
                }
                
                showLoginMessage('✅ 회원가입 성공! 관리자 승인 후 로그인할 수 있습니다.', 'success');
                
                // 3초 후 로그인 폼으로 전환
                setTimeout(() => {
                    showLoginForm();
                    document.getElementById('signupUsername').value = '';
                    document.getElementById('signupPassword').value = '';
                    document.getElementById('signupPasswordConfirm').value = '';
                }, 3000);
                
            } catch (error) {
                showLoginMessage('회원가입 오류: ' + error.message, 'error');
            }
        }
        
        // 로그인
        async function login(auto = false) {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const autoLogin = document.getElementById('autoLoginCheck').checked;
            
            if (!username || !password) {
                if (!auto) showLoginMessage('사용자명과 비밀번호를 입력하세요.', 'error');
                return;
            }
            
            try {
                const { data: userData, error: userError } = await supabase
                    .from('user_accounts')
                    .select('*')
                    .eq('username', username)
                    .single();
                
                if (userError || !userData) {
                    if (!auto) showLoginMessage('사용자를 찾을 수 없습니다.', 'error');
                    if (auto) clearAutoLogin();
                    return;
                }
                
                if (userData.status !== 'approved') {
                    if (!auto) showLoginMessage('계정이 승인되지 않았거나 정지되었습니다.', 'error');
                    if (auto) clearAutoLogin();
                    return;
                }
                
                const { data: pinValid, error: pinError } = await supabase.rpc('verify_pin', {
                    username_param: username,
                    pin_param: password
                });
                
                if (pinError || !pinValid) {
                    if (!auto) showLoginMessage('비밀번호가 올바르지 않습니다.', 'error');
                    if (auto) clearAutoLogin();
                    return;
                }
                
                // 로그인 성공!
                currentUser = userData.username;
                isAdmin = userData.is_admin || false;
                
                // 자동 로그인 저장
                if (autoLogin) {
                    localStorage.setItem('function_username', username);
                    localStorage.setItem('function_password', password);
                } else {
                    clearAutoLogin();
                }
                
                // 마지막 로그인 업데이트
                await supabase.from('user_accounts').update({
                    last_login: new Date().toISOString()
                }).eq('username', username);
                
                showMainView();
                
            } catch (error) {
                if (!auto) showLoginMessage('로그인 실패: ' + error.message, 'error');
            }
        }
        
        function clearAutoLogin() {
            localStorage.removeItem('function_username');
            localStorage.removeItem('function_password');
        }
        
        function showLoginMessage(msg, type) {
            const msgDiv = document.getElementById('loginMessage');
            msgDiv.className = `message ${type}`;
            msgDiv.textContent = msg;
        }
        
        function showMainView() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainView').classList.add('active');
            
            document.getElementById('headerUsername').textContent = currentUser;
            
            if (isAdmin) {
                document.getElementById('adminBadge').style.display = 'inline';
                document.getElementById('adminTabBtn').style.display = 'block';
                document.getElementById('updateWriteForm').style.display = 'block';
                document.getElementById('announcementAdmin').style.display = 'block';  // 공지 작성 표시
            }
            
            // 초기 데이터 로드
            loadAnnouncements();  // 공지사항 로드
            loadMyStats(); // 오늘 탭 + 실시간 정보
            loadWeekStats(); // 7일 탭 (미리 로드)
            loadUpdates(); // 업데이트 탭 (미리 로드)
            
            if (isAdmin) {
                loadAdminPanel();
            }
            
            // 5분마다 자동 새로고침
            setInterval(() => {
                loadMyStats(); // 실시간 정보는 항상 업데이트
                
                // 현재 활성 탭에 따라 데이터 새로고침
                if (document.getElementById('weekTab').classList.contains('active')) {
                    loadWeekStats();
                } else if (document.getElementById('historyTab').classList.contains('active')) {
                    // 그래프는 자동 새로고침 안 함 (버튼으로만 로드)
                } else if (document.getElementById('rankingTab').classList.contains('active')) {
                    loadRanking();
                } else if (document.getElementById('updatesTab').classList.contains('active')) {
                    loadUpdates();
                } else if (isAdmin && document.getElementById('adminTab').classList.contains('active')) {
                    loadAdminPanel();
                }
            }, 300000);
        }
        
        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                clearAutoLogin();
                currentUser = null;
                isAdmin = false;
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainView').classList.remove('active');
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginMessage').innerHTML = '';
            }
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'today') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('todayTab').classList.add('active');
                loadMyStats();
            } else if (tabName === 'week') {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('weekTab').classList.add('active');
                loadWeekStats();
            } else if (tabName === 'history') {
                document.querySelectorAll('.tab-btn')[2].classList.add('active');
                document.getElementById('historyTab').classList.add('active');
                loadScoreGraph(500);
            } else if (tabName === 'matches') {
                document.querySelectorAll('.tab-btn')[3].classList.add('active');
                document.getElementById('matchesTab').classList.add('active');
                loadMyMatches();
            } else if (tabName === 'ranking') {
                document.querySelectorAll('.tab-btn')[4].classList.add('active');
                document.getElementById('rankingTab').classList.add('active');
                loadRanking();
            } else if (tabName === 'updates') {
                document.querySelectorAll('.tab-btn')[5].classList.add('active');
                document.getElementById('updatesTab').classList.add('active');
                loadUpdates();
            } else if (tabName === 'admin' && isAdmin) {
                document.getElementById('adminTabBtn').classList.add('active');
                document.getElementById('adminTab').classList.add('active');
                loadAdminPanel();
            }
        }
        
        // 내 통계 로드 (실시간 정보 포함)
        async function loadMyStats() {
            // 전체 통계 로드 (실시간 정보용)
            const { data: stats } = await supabase
                .from('game_stats')
                .select('*')
                .eq('username', currentUser)
                .single();
            
            if (stats) {
                // 실시간 미니창 정보 (현재 값 표시)
                document.getElementById('liveScore').textContent = stats.current_score || '--';
                
                // 등수 표시 (순위권이탈 포함)
                const rankElement = document.getElementById('liveRank');
                if (stats.current_rank && stats.current_rank < 99999) {
                    rankElement.textContent = stats.current_rank;
                    rankElement.style.fontSize = '20px';
                } else if (stats.current_rank >= 99999) {
                    rankElement.textContent = '순위권이탈';
                    rankElement.style.fontSize = '12px';
                } else {
                    rankElement.textContent = '--';
                    rankElement.style.fontSize = '20px';
                }
                
                document.getElementById('liveTier').textContent = stats.current_tier || '--';
                document.getElementById('liveWLD').textContent = `${stats.wins || 0}-${stats.draws || 0}-${stats.losses || 0}`;
                document.getElementById('liveFC').textContent = stats.fc_mined || 0;
                document.getElementById('liveMatches').textContent = stats.matches || 0;
                
                // 게임 상태 (프로그램에서 전달받은 값)
                const status = stats.game_status || '대기 중';
                document.getElementById('liveStatus').textContent = status;
                
                if (status === '게임 중') {
                    document.getElementById('liveStatus').classList.add('in-game');
                } else {
                    document.getElementById('liveStatus').classList.remove('in-game');
                }
                
                // 활성 모드 태그 표시
                const tagsContainer = document.getElementById('liveTags');
                const activeModes = stats.active_modes ? stats.active_modes.split(',').filter(m => m.trim()) : [];
                
                if (activeModes.length > 0) {
                    tagsContainer.innerHTML = activeModes.map(mode => 
                        `<span class="mini-tag">${mode}</span>`
                    ).join('');
                } else {
                    tagsContainer.innerHTML = '';
                }
            }
            
            // 오늘의 통계 로드 (한국 시간 기준)
            const today = getTodayKST();
            const { data: todaySession } = await supabase
                .from('daily_sessions')
                .select('*')
                .eq('username', currentUser)
                .eq('session_date', today)
                .single();
            
            if (todaySession) {
                document.getElementById('todayWins').textContent = todaySession.wins || 0;
                document.getElementById('todayLosses').textContent = todaySession.losses || 0;
                document.getElementById('todayDraws').textContent = todaySession.draws || 0;
                document.getElementById('todayMatches').textContent = todaySession.matches || 0;
                document.getElementById('todayFC').textContent = todaySession.fc_mined || 0;
                document.getElementById('todayStartScore').textContent = todaySession.start_score || '--';
                document.getElementById('todayHighScore').textContent = todaySession.highest_score || '--';
                
                const total = (todaySession.wins || 0) + (todaySession.losses || 0) + (todaySession.draws || 0);
                const winrate = total > 0 ? ((todaySession.wins || 0) / total * 100).toFixed(1) : 0;
                document.getElementById('todayWinrate').textContent = winrate + '%';
            }
            
            // 승급 정보 로드
            await loadPromotionInfo();
        }
        
        // 넥슨 전적 로드
        async function loadMyMatches() {
            try {
                // 마지막 동기화 시간 로드
                const { data: syncData } = await supabase
                    .from('nexon_sync')
                    .select('last_synced, fifa_nickname')
                    .eq('username', currentUser)
                    .single();
                
                if (syncData && syncData.last_synced) {
                    const lastSync = new Date(syncData.last_synced);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - lastSync) / 1000 / 60);
                    
                    let timeStr = '';
                    if (diffMinutes < 1) {
                        timeStr = '방금 전';
                    } else if (diffMinutes < 60) {
                        timeStr = `${diffMinutes}분 전`;
                    } else if (diffMinutes < 1440) {
                        timeStr = `${Math.floor(diffMinutes / 60)}시간 전`;
                    } else {
                        timeStr = `${Math.floor(diffMinutes / 1440)}일 전`;
                    }
                    
                    document.getElementById('lastSyncTime').textContent = `마지막 동기화: ${timeStr}`;
                } else {
                    document.getElementById('lastSyncTime').textContent = '마지막 동기화: 없음';
                }
                
                // 전적 데이터 로드 (최근 30경기)
                const { data: matches } = await supabase
                    .from('nexon_match_history')
                    .select('*')
                    .eq('username', currentUser)
                    .order('match_date', { ascending: false })
                    .limit(30);
                
                const tbody = document.getElementById('matchesTableBody');
                
                if (!matches || matches.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#8b949e;">전적 데이터가 없습니다.<br>프로그램 설정에서 전적 동기화를 실행해주세요.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = matches.map(match => {
                    // 날짜 포맷 (UTC → 한국 시간 KST 변환)
                    const dateStr = match.match_date.replace('T', ' ').replace('Z', '').replace('+00:00', '');
                    const utcDate = new Date(dateStr + 'Z'); // UTC로 파싱
                    
                    // 한국 시간으로 변환 (UTC+9)
                    const kstDate = new Date(utcDate.getTime() + (9 * 60 * 60 * 1000));
                    const month = kstDate.getUTCMonth() + 1;
                    const day = kstDate.getUTCDate();
                    const hours = kstDate.getUTCHours().toString().padStart(2, '0');
                    const minutes = kstDate.getUTCMinutes().toString().padStart(2, '0');
                    const formattedDateStr = `${month}/${day} ${hours}:${minutes}`;
                    
                    // 결과 표시
                    let resultHtml = '';
                    let resultColor = '';
                    if (match.result === 'win') {
                        resultHtml = '승';
                        resultColor = '#58a6ff';
                    } else if (match.result === 'draw') {
                        resultHtml = '무';
                        resultColor = '#fcd34d';
                    } else {
                        resultHtml = '패';
                        resultColor = '#fca5a5';
                    }
                    
                    // 점수 표시
                    const scoreStr = `${match.my_score} : ${match.opponent_score}`;
                    
                    return `
                        <tr>
                            <td style="color: #8b949e;">${formattedDateStr}</td>
                            <td style="color: ${resultColor}; font-weight: bold;">${resultHtml}</td>
                            <td style="color: #e0e0e0; font-weight: bold;">${scoreStr}</td>
                            <td style="color: #8b949e;">${match.opponent_name || '알 수 없음'}</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('전적 로드 오류:', error);
                document.getElementById('matchesTableBody').innerHTML = 
                    '<tr><td colspan="4" style="text-align:center;color:#fca5a5;">전적 로드 실패</td></tr>';
            }
        }
        
        // 전적 동기화 요청
        async function requestMatchSync() {
            try {
                const btn = document.getElementById('syncMatchesBtn');
                const statusEl = document.getElementById('syncStatus');
                
                // 버튼 비활성화
                btn.disabled = true;
                btn.textContent = '⏳ 요청 중...';
                
                // 피파 닉네임 확인
                const { data: syncData } = await supabase
                    .from('nexon_sync')
                    .select('fifa_nickname')
                    .eq('username', currentUser)
                    .single();
                
                if (!syncData || !syncData.fifa_nickname) {
                    statusEl.textContent = '⚠️ 먼저 프로그램 설정에서 피파 닉네임을 등록해주세요.';
                    statusEl.style.color = '#fca5a5';
                    statusEl.style.display = 'block';
                    
                    btn.disabled = false;
                    btn.textContent = '🔄 전적 동기화';
                    return;
                }
                
                // 동기화 요청 플래그 설정
                await supabase
                    .from('nexon_sync')
                    .update({ sync_requested: true })
                    .eq('username', currentUser);
                
                statusEl.textContent = '✅ 동기화 요청 완료! 프로그램이 실행 중이면 10초 내에 자동으로 동기화됩니다.';
                statusEl.style.color = '#58a6ff';
                statusEl.style.display = 'block';
                
                // 15초 후 자동으로 새로고침
                setTimeout(() => {
                    loadMyMatches();
                    statusEl.style.display = 'none';
                }, 15000);
                
                btn.disabled = false;
                btn.textContent = '🔄 전적 동기화';
                
            } catch (error) {
                console.error('전적 동기화 요청 오류:', error);
                
                const statusEl = document.getElementById('syncStatus');
                statusEl.textContent = '❌ 동기화 요청 실패: ' + error.message;
                statusEl.style.color = '#fca5a5';
                statusEl.style.display = 'block';
                
                const btn = document.getElementById('syncMatchesBtn');
                btn.disabled = false;
                btn.textContent = '🔄 전적 동기화';
            }
        }
        
        // 최근 7일 통계 로드 (한국 시간 기준)
        async function loadWeekStats() {
            // 한국 시간 기준으로 7일 전 날짜 계산
            const now = new Date();
            const kstOffset = 9 * 60 * 60 * 1000; // 9시간을 밀리초로
            const kstNow = new Date(now.getTime() + kstOffset);
            kstNow.setDate(kstNow.getDate() - 7);
            const sevenDaysAgo = kstNow.toISOString().split('T')[0];
            
            const { data: weekData } = await supabase
                .from('daily_sessions')
                .select('*')
                .eq('username', currentUser)
                .gte('session_date', sevenDaysAgo)
                .order('session_date', { ascending: false });
            
            const tbody = document.getElementById('weekTableBody');
            
            if (!weekData || weekData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#8b949e;">데이터가 없습니다</td></tr>';
                return;
            }
            
            // 슈챌→챔스 승급 정보 가져오기 (한국 시간 기준)
            const { data: promotions } = await supabase
                .from('tier_promotions')
                .select('*')
                .eq('username', currentUser)
                .eq('from_tier', '슈챌')
                .eq('to_tier', '챔스')
                .gte('promoted_at', sevenDaysAgo)
                .order('promoted_at', { ascending: false });
            
            // 날짜별 승급 정보 매핑
            const promotionMap = {};
            if (promotions) {
                promotions.forEach(p => {
                    const date = p.promoted_at.split('T')[0];
                    promotionMap[date] = p.matches_taken;
                });
            }
            
            // 표 채우기
            let html = '';
            weekData.forEach(day => {
                const date = new Date(day.session_date);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                
                const wins = day.wins || 0;
                const losses = day.losses || 0;
                const draws = day.draws || 0;
                const total = wins + losses + draws;
                const winrate = total > 0 ? ((wins / total) * 100).toFixed(1) : '0.0';
                const fc = day.fc_mined || 0;
                
                const promotion = promotionMap[day.session_date];
                const promotionText = promotion ? `${promotion}판` : '--';
                
                html += `
                    <tr>
                        <td style="color: #b4b4b4;">${dateStr}</td>
                        <td style="color: #86efac; font-weight: 600;">${wins}</td>
                        <td style="color: #fcd34d; font-weight: 600;">${draws}</td>
                        <td style="color: #fca5a5; font-weight: 600;">${losses}</td>
                        <td style="color: #e0e0e0; font-weight: 600;">${winrate}%</td>
                        <td style="color: #fdba74; font-weight: 600;">${fc}</td>
                        <td style="color: #c4b5fd; font-weight: 600;">${promotionText}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // 슈챌→챔스 승급 정보 로드
        async function loadPromotionInfo() {
            const { data: promotion } = await supabase
                .from('tier_promotions')
                .select('*')
                .eq('username', currentUser)
                .eq('from_tier', '슈챌')
                .eq('to_tier', '챔스')
                .order('promoted_at', { ascending: false })
                .limit(1)
                .single();
            
            if (promotion) {
                document.getElementById('promotionCard').style.display = 'block';
                document.getElementById('promotionMatches').textContent = `${promotion.matches_taken || '--'}판`;
                
                const date = new Date(promotion.promoted_at);
                document.getElementById('promotionDate').textContent = 
                    `${date.getFullYear()}.${date.getMonth() + 1}.${date.getDate()} 승급`;
            } else {
                document.getElementById('promotionCard').style.display = 'none';
            }
        }
        
        // 최근 N경기 점수 그래프
        async function loadScoreGraph(limit) {
            const { data: history } = await supabase
                .from('game_history')
                .select('*')
                .eq('username', currentUser)
                .order('created_at', { ascending: false })
                .limit(limit);
            
            if (!history || history.length === 0) {
                // 데이터가 없을 때 빈 그래프 표시
                const scoreCtx = document.getElementById('scoreChart').getContext('2d');
                if (window.scoreChart) window.scoreChart.destroy();
                window.scoreChart = new Chart(scoreCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '점수',
                            data: [],
                            borderColor: '#94a3b8',
                            backgroundColor: 'rgba(148, 163, 184, 0.1)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: '아직 경기 데이터가 없습니다',
                                color: '#8b949e'
                            }
                        }
                    }
                });
                return;
            }
            
            // 최신 경기가 오른쪽에 오도록 역순 정렬
            history.reverse();
            
            // 실제 점수 추출
            const scores = [];
            const labels = [];
            let gameNumber = 1;
            
            history.forEach((game) => {
                // score_after가 있으면 실제 점수, 없으면 스킵
                if (game.score_after) {
                    scores.push(game.score_after);
                    labels.push(gameNumber.toString());
                    gameNumber++;
                }
            });
            
            if (scores.length === 0) {
                // score_after 데이터가 없을 때
                const scoreCtx = document.getElementById('scoreChart').getContext('2d');
                if (window.scoreChart) window.scoreChart.destroy();
                window.scoreChart = new Chart(scoreCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: '점수',
                            data: [],
                            borderColor: '#94a3b8',
                            backgroundColor: 'rgba(148, 163, 184, 0.1)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: '점수 데이터가 없습니다 (프로그램을 최신 버전으로 업데이트하세요)',
                                color: '#f85149'
                            }
                        }
                    }
                });
                return;
            }
            
            // 점수 그래프
            const scoreCtx = document.getElementById('scoreChart').getContext('2d');
            try { if (window.scoreChart) window.scoreChart.destroy(); } catch(e) {}
            window.scoreChart = new Chart(scoreCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '점수',
                        data: scores,
                        borderColor: '#58a6ff',
                        backgroundColor: 'rgba(88, 166, 255, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '점수: ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '경기',
                                color: '#8b949e',
                                font: { size: 12 }
                            },
                            ticks: { 
                                color: '#8b949e', 
                                maxTicksLimit: 20
                            },
                            grid: { color: '#30363d' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '점수',
                                color: '#8b949e',
                                font: { size: 12 }
                            },
                            ticks: { 
                                color: '#8b949e',
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            grid: { color: '#30363d' }
                        }
                    }
                }
            });
            
            // 버튼 활성화 상태 변경
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.textContent.includes(limit + '경기')) {
                    btn.classList.add('active');
                } else if (btn.textContent.includes('경기')) {
                    btn.classList.remove('active');
                }
            });
        }
        
        // 랭킹 로드
        async function loadRanking() {
            const { data: rankings } = await supabase
                .from('game_stats')
                .select('*')
                .order('wins', { ascending: false })
                .limit(50);
            
            const tbody = document.getElementById('rankingBody');
            tbody.innerHTML = '';
            
            if (rankings && rankings.length > 0) {
                rankings.forEach((rank, index) => {
                    const total = (rank.wins || 0) + (rank.losses || 0) + (rank.draws || 0);
                    const winrate = total > 0 ? ((rank.wins || 0) / total * 100).toFixed(1) : 0;
                    const isMe = rank.username === currentUser;
                    
                    let rankClass = '';
                    if (index === 0) rankClass = 'rank-1';
                    else if (index === 1) rankClass = 'rank-2';
                    else if (index === 2) rankClass = 'rank-3';
                    
                    tbody.innerHTML += `
                        <tr class="${rankClass} ${isMe ? 'me-row' : ''}">
                            <td>${index + 1}${index < 3 ? '🏆' : ''}</td>
                            <td><strong>${rank.username}</strong>${isMe ? ' (나)' : ''}</td>
                            <td>${rank.wins || 0}</td>
                            <td>${rank.losses || 0}</td>
                            <td>${rank.draws || 0}</td>
                            <td>${winrate}%</td>
                        </tr>
                    `;
                });
            }
        }
        
        // 관리자 패널
        async function loadAdminPanel() {
            const { data: users } = await supabase.from('user_accounts').select('*');
            
            if (users) {
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('pendingUsers').textContent = users.filter(u => u.status === 'pending').length;
                document.getElementById('approvedUsers').textContent = users.filter(u => u.status === 'approved').length;
                
                const today = getTodayKST();
                const activeToday = users.filter(u => u.last_login && u.last_login.startsWith(today)).length;
                document.getElementById('activeToday').textContent = activeToday;
                
                // 승인 대기
                const pendingBody = document.getElementById('pendingUsersBody');
                pendingBody.innerHTML = '';
                const pending = users.filter(u => u.status === 'pending');
                
                if (pending.length === 0) {
                    pendingBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#8b949e;">없음</td></tr>';
                } else {
                    pending.forEach(user => {
                        pendingBody.innerHTML += `
                            <tr>
                                <td><strong>${user.username}</strong></td>
                                <td>${new Date(user.created_at).toLocaleDateString('ko-KR')}</td>
                                <td class="action-buttons">
                                    <button class="btn-approve" onclick="approveUser('${user.username}')">✓</button>
                                    <button class="btn-reject" onclick="rejectUser('${user.username}')">✗</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                // 승인된 회원
                const approvedBody = document.getElementById('approvedUsersBody');
                approvedBody.innerHTML = '';
                const approved = users.filter(u => u.status === 'approved');
                
                approved.forEach(user => {
                    const lastLogin = user.last_login ? new Date(user.last_login).toLocaleDateString('ko-KR') : '없음';
                    approvedBody.innerHTML += `
                        <tr>
                            <td><strong>${user.username}</strong>${user.is_admin ? ' 👑' : ''}</td>
                            <td>${lastLogin}</td>
                            <td class="action-buttons">
                                ${!user.is_admin ? `
                                    <button class="btn-suspend" onclick="suspendUser('${user.username}')">⏸</button>
                                    <button class="btn-delete" onclick="deleteUser('${user.username}')">🗑</button>
                                ` : '<span style="color:#8b949e;">관리자</span>'}
                            </td>
                        </tr>
                    `;
                });
                
                // 정지된 회원
                const suspendedBody = document.getElementById('suspendedUsersBody');
                suspendedBody.innerHTML = '';
                const suspended = users.filter(u => u.status === 'suspended');
                
                if (suspended.length === 0) {
                    suspendedBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#8b949e;">없음</td></tr>';
                } else {
                    suspended.forEach(user => {
                        const suspendedDate = user.updated_at ? new Date(user.updated_at).toLocaleDateString('ko-KR') : '알 수 없음';
                        suspendedBody.innerHTML += `
                            <tr>
                                <td><strong>${user.username}</strong></td>
                                <td>${suspendedDate}</td>
                                <td class="action-buttons">
                                    <button class="btn-approve" onclick="restoreUser('${user.username}')">✓ 복귀</button>
                                    <button class="btn-delete" onclick="deleteUser('${user.username}')">🗑</button>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                // 거부된 회원
                const rejectedBody = document.getElementById('rejectedUsersBody');
                rejectedBody.innerHTML = '';
                const rejected = users.filter(u => u.status === 'rejected');
                
                if (rejected.length === 0) {
                    rejectedBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#8b949e;">없음</td></tr>';
                } else {
                    rejected.forEach(user => {
                        const rejectedDate = user.updated_at ? new Date(user.updated_at).toLocaleDateString('ko-KR') : '알 수 없음';
                        rejectedBody.innerHTML += `
                            <tr>
                                <td><strong>${user.username}</strong></td>
                                <td>${rejectedDate}</td>
                                <td class="action-buttons">
                                    <button class="btn-approve" onclick="restoreUser('${user.username}')">✓ 복귀</button>
                                    <button class="btn-delete" onclick="deleteUser('${user.username}')">🗑</button>
                                </td>
                            </tr>
                        `;
                    });
                }
            }
        }
        
        async function approveUser(username) {
            if (!confirm(`'${username}' 승인?`)) return;
            
            try {
                const { data, error } = await supabase.from('user_accounts').update({
                    status: 'approved',
                    approved_at: new Date().toISOString(),
                    approved_by: currentUser
                }).eq('username', username);
                
                if (error) throw error;
                
                alert('✅ 승인 완료!');
                await loadAdminPanel(); // await 추가
                
            } catch (error) {
                console.error('승인 오류:', error);
                alert('❌ 승인 실패: ' + error.message);
            }
        }
        
        async function rejectUser(username) {
            if (!confirm(`'${username}' 거부?`)) return;
            
            try {
                const { error } = await supabase.from('user_accounts').update({ 
                    status: 'rejected' 
                }).eq('username', username);
                
                if (error) throw error;
                
                alert('✅ 거부 완료');
                await loadAdminPanel();
                
            } catch (error) {
                console.error('거부 오류:', error);
                alert('❌ 거부 실패: ' + error.message);
            }
        }
        
        async function suspendUser(username) {
            if (!confirm(`'${username}' 정지?`)) return;
            
            try {
                const { error } = await supabase.from('user_accounts').update({ 
                    status: 'suspended' 
                }).eq('username', username);
                
                if (error) throw error;
                
                alert('✅ 정지 완료');
                await loadAdminPanel();
                
            } catch (error) {
                console.error('정지 오류:', error);
                alert('❌ 정지 실패: ' + error.message);
            }
        }
        
        async function deleteUser(username) {
            if (!confirm(`'${username}' 삭제?\n통계도 삭제됩니다!`)) return;
            
            try {
                // 통계 삭제
                const { error: statsError } = await supabase.from('game_stats').delete().eq('username', username);
                if (statsError) throw statsError;
                
                // 계정 삭제
                const { error: userError } = await supabase.from('user_accounts').delete().eq('username', username);
                if (userError) throw userError;
                
                alert('✅ 삭제 완료');
                await loadAdminPanel();
                
            } catch (error) {
                console.error('삭제 오류:', error);
                alert('❌ 삭제 실패: ' + error.message);
            }
        }
        
        async function restoreUser(username) {
            if (!confirm(`'${username}' 복귀 (승인 상태로 변경)?`)) return;
            
            try {
                const { error } = await supabase.from('user_accounts').update({
                    status: 'approved',
                    approved_at: new Date().toISOString(),
                    approved_by: currentUser
                }).eq('username', username);
                
                if (error) throw error;
                
                alert('✅ 복귀 완료! 해당 사용자는 다시 로그인할 수 있습니다.');
                await loadAdminPanel();
                
            } catch (error) {
                console.error('복귀 오류:', error);
                alert('❌ 복귀 실패: ' + error.message);
            }
        }
        
        // 업데이트 목록 로드
        async function loadUpdates() {
            const { data: updates } = await supabase
                .from('updates')
                .select('*')
                .order('created_at', { ascending: false });
            
            const list = document.getElementById('updatesList');
            
            if (!updates || updates.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#8b949e;padding:40px;">아직 업데이트 공지가 없습니다.</div>';
                return;
            }
            
            list.innerHTML = updates.map(update => `
                <div style="background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <span style="background: #1f6feb; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-right: 10px;">
                                ${update.version || 'v1.0.0'}
                            </span>
                            <span style="color: #c9d1d9; font-size: 18px; font-weight: bold;">
                                ${update.title}
                            </span>
                        </div>
                        ${isAdmin ? `
                            <button onclick="deleteUpdate(${update.id})" 
                                style="background: #f85149; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                🗑️ 삭제
                            </button>
                        ` : ''}
                    </div>
                    <div style="color: #8b949e; font-size: 12px; margin-bottom: 15px;">
                        ${new Date(update.created_at).toLocaleString('ko-KR')} · ${update.created_by}
                    </div>
                    <div style="color: #c9d1d9; line-height: 1.6; white-space: pre-wrap; margin-bottom: 15px;">
                        ${update.content}
                    </div>
                    ${update.download_url ? `
                        <a href="${update.download_url}" target="_blank" 
                            style="display: inline-block; background: linear-gradient(135deg, #238636 0%, #2ea043 100%); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 14px; transition: transform 0.2s; margin-bottom: 15px;"
                            onmouseover="this.style.transform='translateY(-2px)'" 
                            onmouseout="this.style.transform='translateY(0)'">
                            📥 다운로드
                        </a>
                    ` : ''}
                    
                    <!-- 댓글 섹션 -->
                    <div style="border-top: 1px solid #30363d; padding-top: 15px; margin-top: 15px;">
                        <div style="color: #8b949e; font-size: 14px; margin-bottom: 10px;">💬 댓글</div>
                        <div id="comments-${update.id}" style="margin-bottom: 10px;"></div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="commentInput-${update.id}" placeholder="댓글을 입력하세요..." 
                                style="flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid #30363d; background: #161b22; color: #c9d1d9; font-size: 13px;">
                            <button onclick="postComment(${update.id})" 
                                style="background: #238636; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; white-space: nowrap;">
                                댓글 작성
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // 각 업데이트의 댓글 로드
            updates.forEach(update => loadComments(update.id));
        }
        
        // 업데이트 게시
        async function publishUpdate() {
            const version = document.getElementById('updateVersion').value.trim();
            const title = document.getElementById('updateTitle').value.trim();
            const content = document.getElementById('updateContent').value.trim();
            const downloadUrl = document.getElementById('updateDownloadUrl').value.trim();
            
            if (!version || !title || !content) {
                alert('버전, 제목, 내용은 필수 항목입니다!');
                return;
            }
            
            try {
                const updateData = {
                    version: version,
                    title: title,
                    content: content,
                    created_by: currentUser
                };
                
                // 다운로드 링크가 있으면 추가
                if (downloadUrl) {
                    updateData.download_url = downloadUrl;
                }
                
                const { error } = await supabase.from('updates').insert(updateData);
                
                if (error) throw error;
                
                alert('✅ 업데이트 공지가 게시되었습니다!');
                
                // 입력 필드 초기화
                document.getElementById('updateVersion').value = '';
                document.getElementById('updateTitle').value = '';
                document.getElementById('updateContent').value = '';
                document.getElementById('updateDownloadUrl').value = '';
                
                loadUpdates();
                
            } catch (error) {
                alert('❌ 게시 실패: ' + error.message);
            }
        }
        
        // 업데이트 삭제
        async function deleteUpdate(id) {
            if (!confirm('이 업데이트 공지를 삭제하시겠습니까?')) return;
            
            try {
                const { error } = await supabase.from('updates').delete().eq('id', id);
                
                if (error) throw error;
                
                alert('삭제 완료');
                loadUpdates();
                
            } catch (error) {
                alert('삭제 실패: ' + error.message);
            }
        }
        
        // 랭킹 로드 (오늘의 승수 순위)
        // 랭킹 타입 전환
        let currentRankingType = 'wins';
        
        function showRankingType(type) {
            currentRankingType = type;
            
            // 버튼 활성화 상태 변경
            document.getElementById('winsRankBtn').classList.toggle('active', type === 'wins');
            document.getElementById('scoreRankBtn').classList.toggle('active', type === 'score');
            
            // 테이블 헤더 변경
            const thead = document.getElementById('rankingTableHead');
            if (type === 'wins') {
                thead.innerHTML = `
                    <tr>
                        <th>순위</th>
                        <th>사용자명</th>
                        <th>승</th>
                        <th>패</th>
                        <th>무</th>
                        <th>승률</th>
                    </tr>
                `;
            } else {
                thead.innerHTML = `
                    <tr>
                        <th>순위</th>
                        <th>사용자명</th>
                        <th>실시간 점수</th>
                    </tr>
                `;
            }
            
            // 랭킹 로드
            if (type === 'wins') {
                loadWinsRanking();
            } else {
                loadScoreRanking();
            }
        }
        
        // 최다승 랭킹 (오늘 기준)
        async function loadWinsRanking() {
            const today = getTodayKST();
            
            try {
                const { data: sessions } = await supabase
                    .from('daily_sessions')
                    .select('*')
                    .eq('session_date', today)
                    .order('wins', { ascending: false });
                
                const tbody = document.getElementById('rankingTableBody');
                
                if (!sessions || sessions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#808080;">오늘 게임한 사용자가 없습니다.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = sessions.map((session, index) => {
                    const total = (session.wins || 0) + (session.losses || 0) + (session.draws || 0);
                    const winrate = total > 0 ? ((session.wins || 0) / total * 100).toFixed(1) : 0;
                    
                    let rankIcon = '';
                    if (index === 0) rankIcon = '🥇';
                    else if (index === 1) rankIcon = '🥈';
                    else if (index === 2) rankIcon = '🥉';
                    else rankIcon = `${index + 1}`;
                    
                    return `
                        <tr style="background: ${index < 3 ? 'rgba(255, 215, 0, 0.05)' : 'transparent'};">
                            <td style="font-size: 18px; font-weight: bold;">${rankIcon}</td>
                            <td><strong>${session.username}</strong></td>
                            <td style="color: #86efac; font-weight: bold;">${session.wins || 0}</td>
                            <td style="color: #fca5a5;">${session.losses || 0}</td>
                            <td style="color: #fcd34d;">${session.draws || 0}</td>
                            <td style="color: #e0e0e0;">${winrate}%</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('랭킹 로드 오류:', error);
                document.getElementById('rankingTableBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align:center;color:#fca5a5;">랭킹 로드 실패</td></tr>';
            }
        }
        
        // 실시간 점수 랭킹
        async function loadScoreRanking() {
            try {
                const { data: stats } = await supabase
                    .from('game_stats')
                    .select('*')
                    .order('current_score', { ascending: false });
                
                const tbody = document.getElementById('rankingTableBody');
                
                if (!stats || stats.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#808080;">사용자가 없습니다.</td></tr>';
                    return;
                }
                
                // current_score가 null이거나 0인 사용자 제외
                const validStats = stats.filter(s => s.current_score && s.current_score > 0);
                
                if (validStats.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#808080;">점수 기록이 없습니다.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = validStats.map((stat, index) => {
                    let rankIcon = '';
                    if (index === 0) rankIcon = '🥇';
                    else if (index === 1) rankIcon = '🥈';
                    else if (index === 2) rankIcon = '🥉';
                    else rankIcon = `${index + 1}`;
                    
                    return `
                        <tr style="background: ${index < 3 ? 'rgba(255, 215, 0, 0.05)' : 'transparent'};">
                            <td style="font-size: 18px; font-weight: bold;">${rankIcon}</td>
                            <td><strong>${stat.username}</strong></td>
                            <td style="color: #e0e0e0; font-weight: bold; font-size: 16px;">${stat.current_score.toLocaleString()}</td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('점수 랭킹 로드 오류:', error);
                document.getElementById('rankingTableBody').innerHTML = 
                    '<tr><td colspan="3" style="text-align:center;color:#fca5a5;">랭킹 로드 실패</td></tr>';
            }
        }
        
        // 기본 랭킹 로드 (호환성)
        async function loadRanking() {
            if (currentRankingType === 'wins') {
                await loadWinsRanking();
            } else {
                await loadScoreRanking();
            }
        }
        
        // 댓글 로드
        async function loadComments(updateId) {
            try {
                const { data: comments } = await supabase
                    .from('update_comments')
                    .select('*')
                    .eq('update_id', updateId)
                    .order('created_at', { ascending: true });
                
                const container = document.getElementById(`comments-${updateId}`);
                
                if (!comments || comments.length === 0) {
                    container.innerHTML = '<div style="color: #8b949e; font-size: 12px; padding: 10px 0;">첫 댓글을 작성해보세요!</div>';
                    return;
                }
                
                container.innerHTML = comments.map(comment => `
                    <div style="background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="color: #58a6ff; font-weight: bold; font-size: 13px;">${comment.username}</span>
                            <span style="color: #8b949e; font-size: 11px;">${new Date(comment.created_at).toLocaleString('ko-KR')}</span>
                        </div>
                        <div style="color: #c9d1d9; font-size: 13px; line-height: 1.4;">${comment.comment}</div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('댓글 로드 오류:', error);
            }
        }
        
        // 댓글 작성
        async function postComment(updateId) {
            const input = document.getElementById(`commentInput-${updateId}`);
            const comment = input.value.trim();
            
            if (!comment) {
                alert('댓글 내용을 입력하세요!');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('update_comments')
                    .insert({
                        update_id: updateId,
                        username: currentUser,
                        comment: comment
                    });
                
                if (error) throw error;
                
                input.value = '';
                loadComments(updateId);
                
            } catch (error) {
                console.error('댓글 작성 오류:', error);
                alert('댓글 작성 실패: ' + error.message);
            }
        }
        
        // 공지사항 로드
        async function loadAnnouncements() {
            try {
                const { data: announcements } = await supabase
                    .from('announcements')
                    .select('*')
                    .eq('active', true)
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                const banner = document.getElementById('announcementBanner');
                
                if (!announcements || announcements.length === 0) {
                    banner.style.display = 'none';
                    return;
                }
                
                const announcement = announcements[0];
                const colors = {
                    info: { bg: '#1a2e3a', border: '#2a5a7a', text: '#58a6ff' },
                    success: { bg: '#1a2e26', border: '#2d4a3e', text: '#86efac' },
                    warning: { bg: '#2e2a1a', border: '#4a422d', text: '#fcd34d' },
                    error: { bg: '#2e1a1a', border: '#4a2d2d', text: '#fca5a5' }
                };
                
                const color = colors[announcement.type] || colors.info;
                
                banner.innerHTML = `
                    <div style="background: ${color.bg}; border: 1px solid ${color.border}; 
                                border-radius: 12px; padding: 15px 20px; margin-bottom: 20px; 
                                display: flex; align-items: center; justify-content: space-between;">
                        <div style="color: ${color.text}; font-weight: 600; flex: 1;">
                            ${announcement.message}
                        </div>
                        ${isAdmin ? `
                            <button onclick="deleteAnnouncement(${announcement.id})" 
                                    style="background: transparent; border: 1px solid ${color.border}; 
                                           color: ${color.text}; padding: 6px 12px; border-radius: 6px; 
                                           cursor: pointer; margin-left: 15px; font-size: 12px;">
                                삭제
                            </button>
                        ` : ''}
                    </div>
                `;
                banner.style.display = 'block';
                
            } catch (error) {
                console.error('공지사항 로드 오류:', error);
            }
        }
        
        // 공지사항 작성 (관리자만)
        async function createAnnouncement() {
            if (!isAdmin) {
                alert('권한이 없습니다.');
                return;
            }
            
            const message = document.getElementById('announcementInput').value.trim();
            const type = document.getElementById('announcementType').value;
            
            if (!message) {
                alert('공지 내용을 입력하세요!');
                return;
            }
            
            try {
                // 기존 공지 비활성화
                await supabase
                    .from('announcements')
                    .update({ active: false })
                    .eq('active', true);
                
                // 새 공지 생성
                const { error } = await supabase
                    .from('announcements')
                    .insert({
                        message: message,
                        type: type,
                        created_by: currentUser,
                        active: true
                    });
                
                if (error) throw error;
                
                alert('✅ 공지가 게시되었습니다!');
                document.getElementById('announcementInput').value = '';
                document.getElementById('announcementType').value = 'info';
                loadAnnouncements();
                
            } catch (error) {
                console.error('공지 작성 오류:', error);
                alert('❌ 공지 작성 실패: ' + error.message);
            }
        }
        
        // 공지사항 삭제 (관리자만)
        async function deleteAnnouncement(id) {
            if (!isAdmin) {
                alert('권한이 없습니다.');
                return;
            }
            
            if (!confirm('이 공지를 삭제하시겠습니까?')) return;
            
            try {
                const { error } = await supabase
                    .from('announcements')
                    .update({ active: false })
                    .eq('id', id);
                
                if (error) throw error;
                
                alert('삭제 완료');
                loadAnnouncements();
                
            } catch (error) {
                console.error('공지 삭제 오류:', error);
                alert('삭제 실패: ' + error.message);
            }
        }
    </script>
</body>
</html>

